# ═══════════════════════════════════════════════════════════════════════════════
# NEXUS EDGE - Industrial IoT Platform
# Docker Compose Configuration
# ═══════════════════════════════════════════════════════════════════════════════

version: '3.8'

networks:
  nexus-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  nexus-ot:
    driver: bridge
    # This network should bridge to the OT network interface

volumes:
  emqx-data:
  emqx-log:
  timescale-data:
  postgres-data:
  nodered-data:
  grafana-data:
  gateway-logs:

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # CORE INFRASTRUCTURE
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # EMQX MQTT Broker
  # High-performance MQTT broker for unified messaging
  # ─────────────────────────────────────────────────────────────────────────────
  emqx:
    image: emqx/emqx:5.3.2
    container_name: nexus-emqx
    hostname: emqx
    restart: unless-stopped
    environment:
      - EMQX_NAME=nexus-emqx
      - EMQX_HOST=emqx
      - EMQX_CLUSTER__DISCOVERY_STRATEGY=static
      - EMQX_NODE__COOKIE=nexus_secret_cookie
      # Authentication
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_LISTENERS__TCP__DEFAULT__ENABLE=true
      - EMQX_LISTENERS__SSL__DEFAULT__ENABLE=true
      # Performance tuning
      - EMQX_LISTENERS__TCP__DEFAULT__MAX_CONNECTIONS=100000
      - EMQX_MQTT__MAX_TOPIC_LEVELS=10
    ports:
      - "1883:1883"      # MQTT TCP
      - "8883:8883"      # MQTT SSL
      - "8083:8083"      # MQTT WebSocket
      - "8084:8084"      # MQTT WebSocket SSL
      - "18083:18083"    # Dashboard (internal only in prod)
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
      - ./config/emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./config/emqx/acl.conf:/opt/emqx/etc/acl.conf:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ─────────────────────────────────────────────────────────────────────────────
  # TimescaleDB (Historian)
  # Time-series database for industrial data storage
  # ─────────────────────────────────────────────────────────────────────────────
  timescaledb:
    image: timescale/timescaledb:2.13.0-pg15
    container_name: nexus-historian
    hostname: historian
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${HISTORIAN_USER:-nexus}
      - POSTGRES_PASSWORD=${HISTORIAN_PASSWORD:-nexus_historian_secret}
      - POSTGRES_DB=${HISTORIAN_DB:-nexus_historian}
      # Performance tuning for time-series
      - POSTGRES_INITDB_ARGS=--data-checksums
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ./config/timescaledb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HISTORIAN_USER:-nexus} -d ${HISTORIAN_DB:-nexus_historian}"]
      interval: 30s
      timeout: 10s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=timescaledb"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=1GB"
      - "-c"
      - "effective_cache_size=3GB"
      - "-c"
      - "work_mem=64MB"
      - "-c"
      - "maintenance_work_mem=512MB"

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL (Configuration Store)
  # Relational database for app configuration, users, etc.
  # ─────────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: nexus-postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-nexus}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-nexus_config_secret}
      - POSTGRES_DB=${POSTGRES_DB:-nexus_config}
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nexus}"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # NEXUS SERVICES
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # Gateway Core
  # Central API Gateway with authentication and routing
  # ─────────────────────────────────────────────────────────────────────────────
  gateway-core:
    build:
      context: ../../services/gateway-core
      dockerfile: Dockerfile
    image: nexus/gateway-core:${VERSION:-latest}
    container_name: nexus-gateway
    hostname: gateway
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - JWT_EXPIRY=24h
      # Database connections
      - DATABASE_URL=postgresql://${POSTGRES_USER:-nexus}:${POSTGRES_PASSWORD:-nexus_config_secret}@postgres:5432/${POSTGRES_DB:-nexus_config}
      - HISTORIAN_URL=postgresql://${HISTORIAN_USER:-nexus}:${HISTORIAN_PASSWORD:-nexus_historian_secret}@historian:5432/${HISTORIAN_DB:-nexus_historian}
      # MQTT connection
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_GATEWAY_USER:-gateway}
      - MQTT_PASSWORD=${MQTT_GATEWAY_PASS:-gateway_secret}
      # Internal services
      - PROTOCOL_GATEWAY_URL=http://protocol-gateway:4000
      - FLOW_ENGINE_URL=http://flow-engine:1880
      - ORCHESTRATOR_URL=http://orchestrator:5000
      - ALERT_SERVICE_URL=http://alert-service:6000
    ports:
      - "3000:3000"
    volumes:
      - gateway-logs:/app/logs
    networks:
      - nexus-internal
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Protocol Gateway
  # Industrial protocol conversion (S7, OPC UA, Modbus → MQTT)
  # ─────────────────────────────────────────────────────────────────────────────
  protocol-gateway:
    build:
      context: ../../services/protocol-gateway
      dockerfile: Dockerfile
    image: nexus/protocol-gateway:${VERSION:-latest}
    container_name: nexus-protocol-gateway
    hostname: protocol-gateway
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=4000
      # MQTT connection
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_PROTOCOL_USER:-protocol-gateway}
      - MQTT_PASSWORD=${MQTT_PROTOCOL_PASS:-protocol_secret}
      # Database for device configs
      - DATABASE_URL=postgresql://${POSTGRES_USER:-nexus}:${POSTGRES_PASSWORD:-nexus_config_secret}@postgres:5432/${POSTGRES_DB:-nexus_config}
      # Default polling interval (ms)
      - DEFAULT_POLL_INTERVAL=1000
      # Enable protocols
      - ENABLE_S7=true
      - ENABLE_OPCUA=true
      - ENABLE_MODBUS=true
    ports:
      - "4000:4000"
    networks:
      - nexus-internal
      - nexus-ot  # Access to OT network for PLC communication
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Flow Engine (Node-RED based)
  # Flow-based processing and automation
  # ─────────────────────────────────────────────────────────────────────────────
  flow-engine:
    build:
      context: ../../services/flow-engine
      dockerfile: Dockerfile
    image: nexus/flow-engine:${VERSION:-latest}
    container_name: nexus-flow-engine
    hostname: flow-engine
    restart: unless-stopped
    environment:
      - NODE_RED_ENABLE_PROJECTS=true
      - NODE_RED_CREDENTIAL_SECRET=${NODERED_CREDENTIAL_SECRET:-your-node-red-secret}
      # MQTT connection
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_FLOW_USER:-flow-engine}
      - MQTT_PASSWORD=${MQTT_FLOW_PASS:-flow_secret}
      # Historian connection
      - HISTORIAN_URL=postgresql://${HISTORIAN_USER:-nexus}:${HISTORIAN_PASSWORD:-nexus_historian_secret}@historian:5432/${HISTORIAN_DB:-nexus_historian}
    ports:
      - "1880:1880"
    volumes:
      - nodered-data:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
    networks:
      - nexus-internal
    depends_on:
      emqx:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1880/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Historian Service
  # Data ingestion and query service for time-series data
  # ─────────────────────────────────────────────────────────────────────────────
  historian-service:
    build:
      context: ../../services/historian-service
      dockerfile: Dockerfile
    image: nexus/historian-service:${VERSION:-latest}
    container_name: nexus-historian-service
    hostname: historian-service
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=7000
      # MQTT connection for data ingestion
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_HISTORIAN_USER:-historian}
      - MQTT_PASSWORD=${MQTT_HISTORIAN_PASS:-historian_secret}
      - MQTT_SUBSCRIBE_TOPICS=+/+/+/#
      # Historian database
      - DATABASE_URL=postgresql://${HISTORIAN_USER:-nexus}:${HISTORIAN_PASSWORD:-nexus_historian_secret}@historian:5432/${HISTORIAN_DB:-nexus_historian}
      # Batch settings
      - BATCH_SIZE=1000
      - BATCH_INTERVAL_MS=5000
    ports:
      - "7000:7000"
    networks:
      - nexus-internal
    depends_on:
      timescaledb:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Orchestrator Service
  # Container and Kubernetes management
  # ─────────────────────────────────────────────────────────────────────────────
  orchestrator:
    build:
      context: ../../services/orchestrator-service
      dockerfile: Dockerfile
    image: nexus/orchestrator:${VERSION:-latest}
    container_name: nexus-orchestrator
    hostname: orchestrator
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5000
      # Container runtime
      - CONTAINER_RUNTIME=docker  # or 'kubernetes'
      # Docker socket (for Docker mode)
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Kubernetes config (for K8s mode)
      # - KUBECONFIG=/etc/kubernetes/admin.conf
    ports:
      - "5000:5000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # For Kubernetes mode:
      # - /etc/kubernetes/admin.conf:/etc/kubernetes/admin.conf:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Alert Service
  # Real-time alerting and notifications
  # ─────────────────────────────────────────────────────────────────────────────
  alert-service:
    build:
      context: ../../services/alert-service
      dockerfile: Dockerfile
    image: nexus/alert-service:${VERSION:-latest}
    container_name: nexus-alert-service
    hostname: alert-service
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=6000
      # MQTT connection
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_ALERT_USER:-alerts}
      - MQTT_PASSWORD=${MQTT_ALERT_PASS:-alert_secret}
      # Database for alert rules and history
      - DATABASE_URL=postgresql://${POSTGRES_USER:-nexus}:${POSTGRES_PASSWORD:-nexus_config_secret}@postgres:5432/${POSTGRES_DB:-nexus_config}
      # Notification channels (configure as needed)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-alerts@nexus.local}
    ports:
      - "6000:6000"
    networks:
      - nexus-internal
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # NEXUS Control Center (React Frontend)
  # Unified web interface
  # ─────────────────────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api
        - VITE_WS_URL=/ws
    image: nexus/frontend:${VERSION:-latest}
    container_name: nexus-frontend
    hostname: frontend
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - nexus-internal
    depends_on:
      - gateway-core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy
  # SSL termination and routing
  # ─────────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: nexus-nginx
    hostname: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8443:8443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - nexus-internal
    depends_on:
      - frontend
      - gateway-core

  # ═══════════════════════════════════════════════════════════════════════════
  # OPTIONAL: GRAFANA (for advanced visualization)
  # Can be used alongside or instead of native dashboards
  # ═══════════════════════════════════════════════════════════════════════════
  
  grafana:
    image: grafana/grafana:10.2.2
    container_name: nexus-grafana
    hostname: grafana
    restart: unless-stopped
    profiles:
      - grafana  # Only start with: docker-compose --profile grafana up
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      # Anonymous access for embedding
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - nexus-internal
    depends_on:
      timescaledb:
        condition: service_healthy

