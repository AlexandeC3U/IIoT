# ═══════════════════════════════════════════════════════════════════════════════
# NEXUS EDGE - Industrial IoT Platform
# Docker Compose Configuration
# ═══════════════════════════════════════════════════════════════════════════════

networks:
  nexus-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
  nexus-ot:
    driver: bridge
    # This network should bridge to the OT network interface

volumes:
  emqx-data:
  emqx-log:
  timescale-data:
  postgres-data:
  nodered-data:
  grafana-data:
  gateway-logs:

services:
  # ═══════════════════════════════════════════════════════════════════════════
  # CORE INFRASTRUCTURE
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # EMQX MQTT Broker
  # High-performance MQTT broker for unified messaging
  # ─────────────────────────────────────────────────────────────────────────────
  emqx:
    image: emqx/emqx:5.3.2
    container_name: nexus-emqx
    hostname: emqx
    restart: unless-stopped
    environment:
      - EMQX_NAME=nexus-emqx
      - EMQX_HOST=emqx
      - EMQX_CLUSTER__DISCOVERY_STRATEGY=static
      - EMQX_NODE__COOKIE=nexus_secret_cookie
      # Authentication
      - EMQX_ALLOW_ANONYMOUS=false
      - EMQX_LISTENERS__TCP__DEFAULT__ENABLE=true
      - EMQX_LISTENERS__SSL__DEFAULT__ENABLE=true
      # Performance tuning
      - EMQX_LISTENERS__TCP__DEFAULT__MAX_CONNECTIONS=100000
      - EMQX_MQTT__MAX_TOPIC_LEVELS=10
    ports:
      - "1883:1883"      # MQTT TCP
      - "8883:8883"      # MQTT SSL
      - "8083:8083"      # MQTT WebSocket
      - "8084:8084"      # MQTT WebSocket SSL
      - "18083:18083"    # Dashboard (internal only in prod)
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
      - ./config/emqx/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./config/emqx/acl.conf:/opt/emqx/etc/acl.conf:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ─────────────────────────────────────────────────────────────────────────────
  # TimescaleDB (Historian)
  # Time-series database for industrial data storage
  # ─────────────────────────────────────────────────────────────────────────────
  timescaledb:
    image: timescale/timescaledb:2.13.0-pg15
    container_name: nexus-historian
    hostname: historian
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${HISTORIAN_USER:-nexus}
      - POSTGRES_PASSWORD=${HISTORIAN_PASSWORD:-nexus_historian_secret}
      - POSTGRES_DB=${HISTORIAN_DB:-nexus_historian}
      # Performance tuning for time-series
      - POSTGRES_INITDB_ARGS=--data-checksums
    ports:
      - "5432:5432"
    volumes:
      - timescale-data:/var/lib/postgresql/data
      - ../../config/timescaledb/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${HISTORIAN_USER:-nexus} -d ${HISTORIAN_DB:-nexus_historian}"]
      interval: 30s
      timeout: 10s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=timescaledb"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=1GB"
      - "-c"
      - "effective_cache_size=3GB"
      - "-c"
      - "work_mem=64MB"
      - "-c"
      - "maintenance_work_mem=512MB"

  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL (Configuration Store)
  # Relational database for app configuration, users, etc.
  # ─────────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: nexus-postgres
    hostname: postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-nexus}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-nexus_config_secret}
      - POSTGRES_DB=${POSTGRES_DB:-nexus_config}
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ../../config/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nexus} -d ${POSTGRES_DB:-nexus_config}"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # NEXUS SERVICES
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # Gateway Core (TypeScript/Fastify)
  # Device & Tag management API, MQTT config notifications
  # ─────────────────────────────────────────────────────────────────────────────
  gateway-core:
    build:
      context: ../../services/gateway-core
      dockerfile: Dockerfile
    image: nexus/gateway-core:${VERSION:-latest}
    container_name: nexus-gateway-core
    hostname: gateway-core
    restart: unless-stopped
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - HOST=0.0.0.0
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # PostgreSQL config database
      - DATABASE_URL=postgresql://${POSTGRES_USER:-nexus}:${POSTGRES_PASSWORD:-nexus_config_secret}@postgres:5432/${POSTGRES_DB:-nexus_config}
      - DATABASE_POOL_SIZE=10
      # MQTT connection for config notifications
      - MQTT_BROKER_URL=mqtt://emqx:1883
      - MQTT_CLIENT_ID=gateway-core
      - MQTT_USERNAME=${MQTT_GATEWAY_USER:-gateway}
      - MQTT_PASSWORD=${MQTT_GATEWAY_PASS:-gateway_secret}
      # CORS (for frontend)
      - CORS_ORIGIN=http://localhost:5173,http://localhost:8080,http://web-ui
      # JWT (for future auth)
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - JWT_EXPIRES_IN=24h
    ports:
      - "3001:3001"
    volumes:
      - gateway-logs:/app/logs
    networks:
      - nexus-internal
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Protocol Gateway (Go)
  # Industrial protocol conversion (S7, OPC UA, Modbus → MQTT)
  # High-performance Go service using gos7, gopcua, go-modbus libraries
  # ─────────────────────────────────────────────────────────────────────────────
  protocol-gateway:
    build:
      context: ../../services/protocol-gateway
      dockerfile: Dockerfile
    image: nexus/protocol-gateway:${VERSION:-latest}
    container_name: nexus-protocol-gateway
    hostname: protocol-gateway
    restart: unless-stopped
    environment:
      - NEXUS_ENV=${NEXUS_ENV:-production}
      - NEXUS_PORT=4000
      - NEXUS_LOG_LEVEL=${LOG_LEVEL:-info}
      # MQTT connection
      - NEXUS_MQTT_BROKER=tcp://emqx:1883
      - NEXUS_MQTT_USERNAME=${MQTT_PROTOCOL_USER:-protocol-gateway}
      - NEXUS_MQTT_PASSWORD=${MQTT_PROTOCOL_PASS:-protocol_secret}
      - NEXUS_MQTT_CLIENT_ID=protocol-gateway-1
      # Database for device configs
      - NEXUS_DB_HOST=postgres
      - NEXUS_DB_PORT=5432
      - NEXUS_DB_USER=${POSTGRES_USER:-nexus}
      - NEXUS_DB_PASSWORD=${POSTGRES_PASSWORD:-nexus_config_secret}
      - NEXUS_DB_NAME=${POSTGRES_DB:-nexus_config}
      # Default polling interval
      - NEXUS_POLL_INTERVAL_MS=1000
      # Enable protocols
      - NEXUS_S7_ENABLED=true
      - NEXUS_OPCUA_ENABLED=true
      - NEXUS_MODBUS_ENABLED=true
      # Go runtime tuning
      - GOMAXPROCS=4
      - GOGC=100
    ports:
      - "4000:4000"
    networks:
      - nexus-internal
      - nexus-ot  # Access to OT network for PLC communication
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "/app/protocol-gateway", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Flow Engine (Node-RED based)
  # Flow-based processing and automation
  # ─────────────────────────────────────────────────────────────────────────────
  flow-engine:
    build:
      context: ../../services/flow-engine
      dockerfile: Dockerfile
    image: nexus/flow-engine:${VERSION:-latest}
    container_name: nexus-flow-engine
    hostname: flow-engine
    restart: unless-stopped
    environment:
      - NODE_RED_ENABLE_PROJECTS=true
      - NODE_RED_CREDENTIAL_SECRET=${NODERED_CREDENTIAL_SECRET:-your-node-red-secret}
      # MQTT connection
      - MQTT_URL=mqtt://emqx:1883
      - MQTT_USERNAME=${MQTT_FLOW_USER:-flow-engine}
      - MQTT_PASSWORD=${MQTT_FLOW_PASS:-flow_secret}
      # Historian connection
      - HISTORIAN_URL=postgresql://${HISTORIAN_USER:-nexus}:${HISTORIAN_PASSWORD:-nexus_historian_secret}@historian:5432/${HISTORIAN_DB:-nexus_historian}
    ports:
      - "1880:1880"
    volumes:
      - nodered-data:/data
      - ./config/nodered/settings.js:/data/settings.js:ro
    networks:
      - nexus-internal
    depends_on:
      emqx:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1880/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Data Ingestion Service (Go)
  # High-throughput MQTT to TimescaleDB ingestion using pgx COPY protocol
  # ─────────────────────────────────────────────────────────────────────────────
  data-ingestion:
    build:
      context: ../../services/data-ingestion
      dockerfile: Dockerfile
    image: nexus/data-ingestion:${VERSION:-latest}
    container_name: nexus-data-ingestion
    hostname: data-ingestion
    restart: unless-stopped
    environment:
      - ENVIRONMENT=${NEXUS_ENV:-production}
      # MQTT connection for data ingestion (shared subscriptions for scaling)
      - INGESTION_MQTT_BROKER_URL=tcp://emqx:1883
      - MQTT_USERNAME=${MQTT_INGESTION_USER:-ingestion}
      - MQTT_PASSWORD=${MQTT_INGESTION_PASS:-ingestion_secret}
      - INGESTION_MQTT_CLIENT_ID=data-ingestion-1
      # TimescaleDB connection
      - INGESTION_DB_HOST=historian
      - INGESTION_DB_PORT=5432
      - INGESTION_DB_USER=${HISTORIAN_USER:-nexus_ingestion}
      - INGESTION_DB_PASSWORD=${HISTORIAN_PASSWORD:-nexus_historian_secret}
      - INGESTION_DB_NAME=${HISTORIAN_DB:-nexus_historian}
      # Logging
      - INGESTION_LOGGING_LEVEL=${LOG_LEVEL:-info}
      # Go runtime tuning
      - GOMAXPROCS=4
      - GOGC=100
    ports:
      - "7000:8080"
    networks:
      - nexus-internal
    depends_on:
      timescaledb:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Orchestrator Service (Go)
  # Container and Kubernetes management using client-go/docker SDK
  # ─────────────────────────────────────────────────────────────────────────────
  orchestrator:
    build:
      context: ../../services/orchestrator-service
      dockerfile: Dockerfile
    image: nexus/orchestrator:${VERSION:-latest}
    container_name: nexus-orchestrator
    hostname: orchestrator
    restart: unless-stopped
    environment:
      - NEXUS_ENV=${NEXUS_ENV:-production}
      - NEXUS_PORT=5000
      - NEXUS_LOG_LEVEL=${LOG_LEVEL:-info}
      # Container runtime
      - NEXUS_RUNTIME=docker  # or 'kubernetes'
      # Docker socket (for Docker mode)
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Kubernetes config (for K8s mode)
      # - KUBECONFIG=/etc/kubernetes/admin.conf
      # Go runtime tuning
      - GOMAXPROCS=2
    ports:
      - "5000:5000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # For Kubernetes mode:
      # - /etc/kubernetes/admin.conf:/etc/kubernetes/admin.conf:ro
    networks:
      - nexus-internal
    healthcheck:
      test: ["CMD", "/app/orchestrator", "health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Alert Service (Go)
  # Real-time rule evaluation and notifications
  # ─────────────────────────────────────────────────────────────────────────────
  alert-service:
    build:
      context: ../../services/alert-service
      dockerfile: Dockerfile
    image: nexus/alert-service:${VERSION:-latest}
    container_name: nexus-alert-service
    hostname: alert-service
    restart: unless-stopped
    environment:
      - NEXUS_ENV=${NEXUS_ENV:-production}
      - NEXUS_PORT=6000
      - NEXUS_LOG_LEVEL=${LOG_LEVEL:-info}
      # MQTT connection
      - NEXUS_MQTT_BROKER=tcp://emqx:1883
      - NEXUS_MQTT_USERNAME=${MQTT_ALERT_USER:-alerts}
      - NEXUS_MQTT_PASSWORD=${MQTT_ALERT_PASS:-alert_secret}
      - NEXUS_MQTT_CLIENT_ID=alert-service-1
      # Database for alert rules and history
      - NEXUS_DB_HOST=postgres
      - NEXUS_DB_PORT=5432
      - NEXUS_DB_USER=${POSTGRES_USER:-nexus}
      - NEXUS_DB_PASSWORD=${POSTGRES_PASSWORD:-nexus_config_secret}
      - NEXUS_DB_NAME=${POSTGRES_DB:-nexus_config}
      # Notification channels (configure as needed)
      - NEXUS_SMTP_HOST=${SMTP_HOST:-}
      - NEXUS_SMTP_PORT=${SMTP_PORT:-587}
      - NEXUS_SMTP_USER=${SMTP_USER:-}
      - NEXUS_SMTP_PASS=${SMTP_PASS:-}
      - NEXUS_SMTP_FROM=${SMTP_FROM:-alerts@nexus.local}
      # Go runtime tuning
      - GOMAXPROCS=2
    ports:
      - "6000:6000"
    networks:
      - nexus-internal
    depends_on:
      postgres:
        condition: service_healthy
      emqx:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # FRONTEND
  # ═══════════════════════════════════════════════════════════════════════════

  # ─────────────────────────────────────────────────────────────────────────────
  # NEXUS Control Center (React Frontend)
  # Unified web interface (React + Vite + TailwindCSS)
  # Serves static files via Nginx, proxies API calls to gateway-core
  # ─────────────────────────────────────────────────────────────────────────────
  web-ui:
    build:
      context: ../../services/web-ui
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=/api
    image: nexus/web-ui:${VERSION:-latest}
    container_name: nexus-web-ui
    hostname: web-ui
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - nexus-internal
    depends_on:
      - gateway-core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Nginx Reverse Proxy
  # SSL termination and routing
  # ─────────────────────────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: nexus-nginx
    hostname: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8443:8443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - nexus-internal
    depends_on:
      - web-ui
      - gateway-core

  # ═══════════════════════════════════════════════════════════════════════════
  # OPTIONAL: GRAFANA (for advanced visualization)
  # Can be used alongside or instead of native dashboards
  # ═══════════════════════════════════════════════════════════════════════════

  grafana:
    image: grafana/grafana:10.2.2
    container_name: nexus-grafana
    hostname: grafana
    restart: unless-stopped
    profiles:
      - grafana  # Only start with: docker-compose --profile grafana up
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=%(protocol)s://%(domain)s:%(http_port)s/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
      # Anonymous access for embedding
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - nexus-internal
    depends_on:
      timescaledb:
        condition: service_healthy

