# TimescaleDB - Initialization Scripts
# These run once when the database is first created
# NOTE: User creation is now handled by 00-init-users.sh which reads from secrets
apiVersion: v1
kind: ConfigMap
metadata:
  name: timescaledb-init
  namespace: nexus
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: nexus-edge
data:
  # User creation script - reads passwords from environment variables (set from secrets)
  00-init-users.sh: |
    #!/bin/bash
    set -e
    
    # This script reads credentials from environment variables injected from Kubernetes secrets
    # Environment variables expected:
    #   NEXUS_HISTORIAN_PASSWORD - password for nexus_historian role
    #   NEXUS_INGESTION_PASSWORD - password for nexus_ingestion role
    
    echo "Creating database roles from secrets..."
    
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Create nexus_historian role if not exists
        DO \$\$
        BEGIN
            IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'nexus_historian') THEN
                CREATE ROLE nexus_historian WITH LOGIN PASSWORD '${NEXUS_HISTORIAN_PASSWORD}';
                RAISE NOTICE 'Created role nexus_historian';
            ELSE
                -- Update password if role exists
                ALTER ROLE nexus_historian WITH PASSWORD '${NEXUS_HISTORIAN_PASSWORD}';
                RAISE NOTICE 'Updated password for nexus_historian';
            END IF;
        END
        \$\$;
        
        -- Create nexus_ingestion role if not exists
        DO \$\$
        BEGIN
            IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'nexus_ingestion') THEN
                CREATE ROLE nexus_ingestion WITH LOGIN PASSWORD '${NEXUS_INGESTION_PASSWORD}';
                RAISE NOTICE 'Created role nexus_ingestion';
            ELSE
                -- Update password if role exists
                ALTER ROLE nexus_ingestion WITH PASSWORD '${NEXUS_INGESTION_PASSWORD}';
                RAISE NOTICE 'Updated password for nexus_ingestion';
            END IF;
        END
        \$\$;
        
        -- Basic permissions
        GRANT CONNECT ON DATABASE ${POSTGRES_DB} TO nexus_ingestion;
        GRANT CONNECT ON DATABASE ${POSTGRES_DB} TO nexus_historian;
        GRANT USAGE ON SCHEMA public TO nexus_ingestion;
        GRANT USAGE ON SCHEMA public TO nexus_historian;
    EOSQL
    
    echo "Database roles created successfully"
  
  # Schema initialization (see config/timescaledb/init.sql for full version)
  01-init-schema.sql: |
    -- Enable TimescaleDB extension
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    
    -- Main metrics hypertable
    CREATE TABLE IF NOT EXISTS metrics (
        time        TIMESTAMPTZ NOT NULL,
        topic       TEXT NOT NULL,
        device_id   TEXT,
        tag_id      TEXT,
        value       DOUBLE PRECISION,
        value_str   TEXT,
        quality     SMALLINT DEFAULT 192,
        unit        TEXT,
        metadata    JSONB,
        received_at TIMESTAMPTZ DEFAULT NOW(),
        CONSTRAINT metrics_value_check CHECK (value IS NOT NULL OR value_str IS NOT NULL)
    );
    
    -- Convert to hypertable (if not already)
    SELECT create_hypertable('metrics', 'time', 
        chunk_time_interval => INTERVAL '1 day',
        if_not_exists => TRUE
    );
    
    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_metrics_topic ON metrics (topic, time DESC);
    CREATE INDEX IF NOT EXISTS idx_metrics_device ON metrics (device_id, time DESC) WHERE device_id IS NOT NULL;
    CREATE INDEX IF NOT EXISTS idx_metrics_tag ON metrics (tag_id, time DESC) WHERE tag_id IS NOT NULL;
    
    -- Enable compression (chunks older than 7 days)
    ALTER TABLE metrics SET (
        timescaledb.compress,
        timescaledb.compress_segmentby = 'topic',
        timescaledb.compress_orderby = 'time DESC'
    );
    
    SELECT add_compression_policy('metrics', INTERVAL '7 days', if_not_exists => TRUE);
    
    -- Retention policy (drop chunks older than 90 days)
    SELECT add_retention_policy('metrics', INTERVAL '90 days', if_not_exists => TRUE);
    
    -- Grant permissions on tables
    GRANT SELECT, INSERT ON metrics TO nexus_historian;
    GRANT SELECT, INSERT ON metrics TO nexus_ingestion;
    GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO nexus_ingestion;

