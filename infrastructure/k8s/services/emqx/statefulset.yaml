# EMQX MQTT Broker - StatefulSet for Clustering
# EMQX uses Erlang's distributed clustering for HA
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: emqx
  namespace: nexus
  labels:
    app.kubernetes.io/name: emqx
    app.kubernetes.io/component: broker
    app.kubernetes.io/part-of: nexus-edge
spec:
  serviceName: emqx-headless
  replicas: 3
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app.kubernetes.io/name: emqx
  template:
    metadata:
      labels:
        app.kubernetes.io/name: emqx
        app.kubernetes.io/component: broker
        app.kubernetes.io/part-of: nexus-edge
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "18083"
        prometheus.io/path: "/api/v5/prometheus/stats"
    spec:
      serviceAccountName: emqx
      
      containers:
        - name: emqx
          image: emqx:5.4.0
          imagePullPolicy: IfNotPresent
          
          ports:
            - name: mqtt
              containerPort: 1883
              protocol: TCP
            - name: mqtts
              containerPort: 8883
              protocol: TCP
            - name: ws
              containerPort: 8083
              protocol: TCP
            - name: wss
              containerPort: 8084
              protocol: TCP
            - name: dashboard
              containerPort: 18083
              protocol: TCP
            - name: ekka
              containerPort: 4370
              protocol: TCP
            - name: erlang
              containerPort: 5370
              protocol: TCP
          
          env:
            # Cluster configuration using DNS discovery
            - name: EMQX_NAME
              value: "emqx"
            - name: EMQX_CLUSTER__DISCOVERY_STRATEGY
              value: "dns"
            - name: EMQX_CLUSTER__DNS__RECORD_TYPE
              value: "srv"
            - name: EMQX_CLUSTER__DNS__NAME
              value: "emqx-headless.nexus.svc.cluster.local"
            
            # Node name (must be unique per pod)
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: EMQX_NODE__NAME
              value: "$(POD_NAME)@$(POD_NAME).emqx-headless.$(POD_NAMESPACE).svc.cluster.local"
            
            # Dashboard credentials
            - name: EMQX_DASHBOARD__DEFAULT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: emqx-secrets
                  key: EMQX_DASHBOARD__DEFAULT_USERNAME
            - name: EMQX_DASHBOARD__DEFAULT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: emqx-secrets
                  key: EMQX_DASHBOARD__DEFAULT_PASSWORD
            
            # Performance tuning
            - name: EMQX_MQTT__MAX_PACKET_SIZE
              value: "10MB"
            - name: EMQX_MQTT__MAX_MQUEUE_LEN
              value: "10000"
            - name: EMQX_LISTENER__TCP__EXTERNAL__ACCEPTORS
              value: "64"
            
            # Logging
            - name: EMQX_LOG__CONSOLE__LEVEL
              value: "info"
          
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"
          
          volumeMounts:
            - name: emqx-data
              mountPath: /opt/emqx/data
            - name: emqx-log
              mountPath: /opt/emqx/log
          
          livenessProbe:
            httpGet:
              path: /status
              port: dashboard
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          
          readinessProbe:
            httpGet:
              path: /status
              port: dashboard
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
      
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: emqx
              topologyKey: kubernetes.io/hostname
      
      terminationGracePeriodSeconds: 60
  
  volumeClaimTemplates:
    - metadata:
        name: emqx-data
        labels:
          app.kubernetes.io/name: emqx
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
    - metadata:
        name: emqx-log
        labels:
          app.kubernetes.io/name: emqx
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi

