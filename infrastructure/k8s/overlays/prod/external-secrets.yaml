# External Secrets Configuration for Production
# ============================================================================
# This file shows how to integrate with external secret stores
# Requires: External Secrets Operator (ESO) to be installed
#
# Installation:
#   helm repo add external-secrets https://charts.external-secrets.io
#   helm install external-secrets external-secrets/external-secrets \
#     -n external-secrets --create-namespace
#
# Supported backends:
#   - AWS Secrets Manager
#   - HashiCorp Vault
#   - Google Secret Manager
#   - Azure Key Vault
#   - And many more...
# ============================================================================

---
# ClusterSecretStore for HashiCorp Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "https://vault.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "nexus-edge"
          serviceAccountRef:
            name: "external-secrets"
            namespace: "external-secrets"

---
# Alternative: ClusterSecretStore for AWS Secrets Manager
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secretsmanager
spec:
  provider:
    aws:
      service: SecretsManager
      region: eu-west-1
      auth:
        jwt:
          serviceAccountRef:
            name: "external-secrets"
            namespace: "external-secrets"

---
# ExternalSecret - NEXUS Main Secrets (from Vault)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: nexus-secrets
  namespace: nexus
  labels:
    app.kubernetes.io/name: nexus
    app.kubernetes.io/part-of: nexus-edge
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: nexus-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: nexus
          app.kubernetes.io/part-of: nexus-edge
  data:
    - secretKey: MQTT_USERNAME
      remoteRef:
        key: nexus-edge/mqtt
        property: username
    - secretKey: MQTT_PASSWORD
      remoteRef:
        key: nexus-edge/mqtt
        property: password
    - secretKey: TIMESCALEDB_USER
      remoteRef:
        key: nexus-edge/timescaledb
        property: ingestion_user
    - secretKey: TIMESCALEDB_PASSWORD
      remoteRef:
        key: nexus-edge/timescaledb
        property: ingestion_password

---
# ExternalSecret - TimescaleDB Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: timescaledb-secrets
  namespace: nexus
  labels:
    app.kubernetes.io/name: timescaledb
    app.kubernetes.io/part-of: nexus-edge
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: timescaledb-secrets
    creationPolicy: Owner
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: nexus-edge/timescaledb
        property: admin_user
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: nexus-edge/timescaledb
        property: admin_password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: nexus-edge/timescaledb
        property: database
    - secretKey: NEXUS_HISTORIAN_PASSWORD
      remoteRef:
        key: nexus-edge/timescaledb
        property: historian_password
    - secretKey: NEXUS_INGESTION_PASSWORD
      remoteRef:
        key: nexus-edge/timescaledb
        property: ingestion_password
    - secretKey: EXPORTER_DSN
      remoteRef:
        key: nexus-edge/timescaledb
        property: exporter_dsn

---
# ExternalSecret - EMQX Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: emqx-secrets
  namespace: nexus
  labels:
    app.kubernetes.io/name: emqx
    app.kubernetes.io/part-of: nexus-edge
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: emqx-secrets
    creationPolicy: Owner
  data:
    - secretKey: EMQX_DASHBOARD__DEFAULT_USERNAME
      remoteRef:
        key: nexus-edge/emqx
        property: dashboard_username
    - secretKey: EMQX_DASHBOARD__DEFAULT_PASSWORD
      remoteRef:
        key: nexus-edge/emqx
        property: dashboard_password
    - secretKey: MQTT_ADMIN_USERNAME
      remoteRef:
        key: nexus-edge/emqx
        property: admin_username
    - secretKey: MQTT_ADMIN_PASSWORD
      remoteRef:
        key: nexus-edge/emqx
        property: admin_password

---
# ============================================================================
# Vault Setup Instructions
# ============================================================================
# 
# 1. Enable KV secrets engine:
#    vault secrets enable -path=secret kv-v2
#
# 2. Create secrets:
#    vault kv put secret/nexus-edge/mqtt \
#      username="nexus" \
#      password="$(openssl rand -base64 32)"
#
#    vault kv put secret/nexus-edge/timescaledb \
#      admin_user="postgres" \
#      admin_password="$(openssl rand -base64 32)" \
#      database="nexus_historian" \
#      historian_password="$(openssl rand -base64 32)" \
#      ingestion_password="$(openssl rand -base64 32)" \
#      exporter_dsn="postgresql://postgres:PASSWORD@localhost:5432/nexus_historian?sslmode=disable"
#
#    vault kv put secret/nexus-edge/emqx \
#      dashboard_username="admin" \
#      dashboard_password="$(openssl rand -base64 32)" \
#      admin_username="nexus_admin" \
#      admin_password="$(openssl rand -base64 32)"
#
# 3. Create Kubernetes auth method:
#    vault auth enable kubernetes
#    vault write auth/kubernetes/config \
#      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
#
# 4. Create policy:
#    vault policy write nexus-edge - <<EOF
#    path "secret/data/nexus-edge/*" {
#      capabilities = ["read"]
#    }
#    EOF
#
# 5. Create role:
#    vault write auth/kubernetes/role/nexus-edge \
#      bound_service_account_names=external-secrets \
#      bound_service_account_namespaces=external-secrets \
#      policies=nexus-edge \
#      ttl=1h
# ============================================================================

