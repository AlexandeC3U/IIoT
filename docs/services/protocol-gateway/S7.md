# S7 (Siemens) Protocol Adapter

## Overview

The S7 adapter provides bidirectional communication with Siemens PLCs using the S7 communication protocol. It supports reading and writing data blocks, merkers, inputs, outputs, timers, and counters.

## Supported PLC Models

| Model | Rack | Slot | Notes |
|-------|------|------|-------|
| S7-200 Smart | 0 | 1 | Via TCP/IP module |
| S7-300 | 0 | 2 | Standard configuration |
| S7-400 | 0 | 2-3 | Depends on CPU slot |
| S7-1200 | 0 | 0 or 1 | Enable PUT/GET in TIA Portal |
| S7-1500 | 0 | 0 or 1 | Enable PUT/GET in TIA Portal |

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           S7 ADAPTER ARCHITECTURE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          S7 CONNECTION POOL                         │   │
│   │                           (pool.go)                                 │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                    Circuit Breaker                          │   │   │
│   │   │   • Prevents cascading failures                             │   │   │
│   │   │   • Automatic recovery after timeout                        │   │   │
│   │   │   • Per-device circuit breaker                              │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐        │   │
│   │   │ S7 Client │  │ S7 Client │  │ S7 Client │  │ S7 Client │  ...   │   │
│   │   │  PLC-001  │  │  PLC-002  │  │  PLC-003  │  │  PLC-004  │        │   │
│   │   └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘        │   │
│   │         │              │              │              │              │   │
│   └─────────┼──────────────┼──────────────┼──────────────┼──────────────┘   │
│             │              │              │              │                  │
│             ▼              ▼              ▼              ▼                  │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                      ISO-on-TCP (Port 102)                            │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│             │              │              │              │                  │
│             ▼              ▼              ▼              ▼                  │
│       ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐              │
│       │ S7-1200 │    │ S7-1500 │    │  S7-300 │    │  S7-400 │              │
│       └─────────┘    └─────────┘    └─────────┘    └─────────┘              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Files

### `client.go`

**Purpose:** Core S7 client implementation with read/write operations.

**Key Features:**
- Connect/Disconnect with context timeout
- Read single and multiple tags
- Write single and multiple tags
- Symbolic address parsing (DB1.DBD0, MW100, I0.0)
- Direct address components (Area, DBNumber, Offset)
- Automatic retry with exponential backoff
- Value type conversion and scaling

**Key Types:**

```go
type Client struct {
    config     ClientConfig
    handler    *gos7.TCPClientHandler
    client     gos7.Client
    connected  atomic.Bool
    stats      *ClientStats
    deviceID   string
}

type ClientConfig struct {
    Address     string        // PLC IP address
    Port        int           // TCP port (default: 102)
    Rack        int           // Rack number
    Slot        int           // CPU slot
    Timeout     time.Duration // Connection timeout
    IdleTimeout time.Duration // Idle connection timeout
    MaxRetries  int           // Retry attempts
    RetryDelay  time.Duration // Base retry delay
    PDUSize     int           // Max PDU size (default: 480)
}
```

**Key Methods:**

| Method | Description |
|--------|-------------|
| `Connect(ctx)` | Establishes connection to PLC |
| `Disconnect()` | Closes connection |
| `ReadTag(ctx, tag)` | Reads a single tag |
| `ReadTags(ctx, tags)` | Reads multiple tags |
| `WriteTag(ctx, tag, value)` | Writes to a single tag |

### `pool.go`

**Purpose:** Connection pool with circuit breaker protection.

**Key Features:**
- Manages multiple S7 client connections
- Circuit breaker per device (prevents cascading failures)
- Automatic idle connection cleanup
- Health check background task
- Connection reuse for efficiency

**Key Types:**

```go
type Pool struct {
    clients        map[string]*clientEntry
    maxConnections int
    idleTimeout    time.Duration
    healthCheck    time.Duration
}

type clientEntry struct {
    client  *Client
    breaker *gobreaker.CircuitBreaker
    lastUse time.Time
}
```

**Key Methods:**

| Method | Description |
|--------|-------------|
| `GetOrCreate(ctx, device)` | Gets or creates a client |
| `ReadTag(ctx, device, tag)` | Reads with circuit breaker |
| `WriteTag(ctx, device, tag, value)` | Writes with circuit breaker |
| `Remove(deviceID)` | Removes device from pool |
| `Close()` | Closes all connections |

## Memory Areas

| Area | Code | Description | Read | Write |
|------|------|-------------|------|-------|
| DB | 0x84 | Data Blocks | ✅ | ✅ |
| M | 0x83 | Merkers/Flags | ✅ | ✅ |
| I | 0x81 | Inputs | ✅ | ❌ |
| Q | 0x82 | Outputs | ✅ | ✅ |
| T | 0x1D | Timers | ✅ | ✅ |
| C | 0x1C | Counters | ✅ | ✅ |

## Address Syntax

### Symbolic Addresses

The adapter supports standard Siemens symbolic addressing:

| Example | Description |
|---------|-------------|
| `DB1.DBX0.0` | Data Block 1, Byte 0, Bit 0 (Bool) |
| `DB1.DBB10` | Data Block 1, Byte 10 |
| `DB1.DBW100` | Data Block 1, Word at offset 100 |
| `DB1.DBD200` | Data Block 1, Double Word at offset 200 |
| `M0.0` | Merker Byte 0, Bit 0 |
| `MB10` | Merker Byte 10 |
| `MW100` | Merker Word 100 |
| `MD200` | Merker Double Word 200 |
| `I0.0` | Input Byte 0, Bit 0 |
| `IB0` | Input Byte 0 |
| `IW0` | Input Word 0 |
| `Q0.0` | Output Byte 0, Bit 0 |
| `QB0` | Output Byte 0 |
| `T10` | Timer 10 |
| `C20` | Counter 20 |

### Direct Addressing

For programmatic use, you can specify address components directly:

```yaml
tags:
  - id: temperature
    s7_area: DB
    s7_db_number: 1
    s7_offset: 0
    data_type: float32
```

## Data Types

| Type | Size | Description |
|------|------|-------------|
| bool | 1 bit | Boolean (X, DBX) |
| int16 | 2 bytes | Signed 16-bit integer (INT) |
| uint16 | 2 bytes | Unsigned 16-bit integer (WORD) |
| int32 | 4 bytes | Signed 32-bit integer (DINT) |
| uint32 | 4 bytes | Unsigned 32-bit integer (DWORD) |
| float32 | 4 bytes | 32-bit float (REAL) |
| float64 | 8 bytes | 64-bit float (LREAL) |

## Device Configuration

```yaml
devices:
  - id: siemens-plc-001
    name: "Main Assembly Line PLC"
    protocol: s7
    connection:
      host: 192.168.1.50
      port: 102
      s7_rack: 0
      s7_slot: 1
      timeout: 10s
      retry_count: 3
      retry_delay: 500ms
    uns_prefix: plant-a/line-1/plc-001
    poll_interval: 500ms
    enabled: true
    tags:
      - id: motor-speed
        name: "Motor Speed"
        s7_address: "DB1.DBD0"
        data_type: float32
        scale_factor: 1.0
        unit: "rpm"
        topic_suffix: motor/speed
        access_mode: readwrite
        enabled: true

      - id: temperature
        name: "Tank Temperature"
        s7_address: "DB1.DBD4"
        data_type: float32
        scale_factor: 0.1
        offset: -50
        unit: "°C"
        topic_suffix: tank/temperature
        enabled: true

      - id: emergency-stop
        name: "Emergency Stop"
        s7_address: "I0.0"
        data_type: bool
        topic_suffix: safety/estop
        enabled: true

      - id: pump-enable
        name: "Pump Enable"
        s7_address: "Q0.1"
        data_type: bool
        topic_suffix: pump/enable
        access_mode: readwrite
        enabled: true
```

## Data Flow

### Read Operation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            S7 READ DATA FLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Polling Service                 2. S7 Pool                              │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ For each device:    │           │ GetOrCreate(device) │               │
│     │ - Get tags to poll  │──────────►│                     │               │
│     │ - Call pool.ReadTags│           │ Check circuit breaker│              │
│     └─────────────────────┘           └──────────┬──────────┘               │
│                                                  │                          │
│                                                  ▼                          │
│  3. S7 Client                        4. PLC Communication                   │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ Parse S7 address    │           │ ISO-on-TCP frame    │               │
│     │ AGReadDB(db, offset)│──────────►│ S7 protocol request │               │
│     │                     │           │ Read data block     │               │
│     │ Parse raw bytes     │◄──────────│ Return raw bytes    │               │
│     │ Apply scaling       │           └─────────────────────┘               │
│     └──────────┬──────────┘                                                 │
│                │                                                            │
│                ▼                                                            │
│  5. Data Normalizer                  6. MQTT Publisher                      │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ Input:              │           │ Topic: uns/prefix/  │               │
│     │ { raw: 0x42A80000 } │──────────►│        tag_suffix   │               │
│     │                     │           │                     │               │
│     │ Output: 84.0°C      │           │ Publish to EMQX     │               │
│     └─────────────────────┘           └─────────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Write Operation

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           S7 WRITE DATA FLOW                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. MQTT Command Handler            2. Command Validation                   │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ Subscribe:          │           │ Validate:           │               │
│     │ $nexus/cmd/+/+/set  │──────────►│ - Device exists     │               │
│     │                     │           │ - Tag is writable   │               │
│     │ Parse: device, tag  │           │ - Value type valid  │               │
│     └─────────────────────┘           └──────────┬──────────┘               │
│                                                  │                          │
│                                                  ▼                          │
│  3. S7 Pool                          4. S7 Client                           │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ Circuit breaker     │           │ Reverse scaling     │               │
│     │ check               │──────────►│ Value → bytes       │               │
│     │                     │           │ AGWriteDB(...)      │               │
│     └─────────────────────┘           └──────────┬──────────┘               │
│                                                  │                          │
│                                                  ▼                          │
│  5. PLC Write                        6. Response                            │
│     ┌─────────────────────┐           ┌─────────────────────┐               │
│     │ S7 protocol         │           │ Publish response:   │               │
│     │ Write data block    │──────────►│ $nexus/cmd/response │               │
│     │                     │           │                     │               │
│     │ Return status       │           │ {success/error}     │               │
│     └─────────────────────┘           └─────────────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## TIA Portal Configuration

For S7-1200/1500, you must enable PUT/GET communication:

1. Open TIA Portal
2. Navigate to: **Device Configuration → Controller Properties**
3. Go to: **Protection & Security → Connection mechanisms**
4. Enable: **Permit access with PUT/GET communication from remote partner**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  TIA Portal - Device Configuration                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Protection & Security                                                      │
│  └── Connection mechanisms                                                  │
│      └── [✓] Permit access with PUT/GET communication from remote partner   │
│                                                                             │
│  ⚠️ WARNING: This setting has security implications. Only enable in         │
│     controlled environments or implement network segmentation.              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Optimized Data Blocks

For optimized DBs (default in S7-1200/1500), you must disable optimization:

1. Right-click on the Data Block
2. Select **Properties**
3. Go to **Attributes**
4. Uncheck **Optimized block access**

Or create a non-optimized DB with fixed offsets.

## Error Handling

| Error | Description | Recovery |
|-------|-------------|----------|
| `ErrS7ConnectionFailed` | Cannot connect to PLC | Check IP, rack/slot, firewall |
| `ErrS7InvalidAddress` | Address format invalid | Check symbolic address syntax |
| `ErrS7ReadFailed` | Read operation failed | Verify DB exists, offset valid |
| `ErrS7WriteFailed` | Write operation failed | Check write permissions |
| `ErrS7ItemNotAvailable` | Requested item not found | DB number or offset incorrect |
| `ErrCircuitBreakerOpen` | Circuit breaker tripped | Wait for timeout or reconnect |

## Performance Considerations

### Batch Reading

The S7 adapter groups reads by memory area for efficiency:

```go
// Good: Tags grouped by area
tags := []*Tag{
    {S7Address: "DB1.DBD0"},  // DB1
    {S7Address: "DB1.DBD4"},  // DB1 (same DB)
    {S7Address: "DB1.DBD8"},  // DB1 (same DB)
}

// Less efficient: Mixed areas
tags := []*Tag{
    {S7Address: "DB1.DBD0"},  // DB1
    {S7Address: "MW100"},     // Merker
    {S7Address: "DB2.DBD0"},  // DB2
}
```

### PDU Size

The PDU size limits how much data can be transferred in a single request:

| PLC | Default PDU | Max Items per Read |
|-----|-------------|-------------------|
| S7-300 | 240 | ~10 DWORDs |
| S7-400 | 480 | ~20 DWORDs |
| S7-1200 | 240 | ~10 DWORDs |
| S7-1500 | 480 | ~20 DWORDs |

### Connection Pooling

```yaml
# Recommended pool settings
s7:
  max_connections: 100      # Per gateway instance
  idle_timeout: 5m          # Close idle connections
  health_check_interval: 30s
```

## Comparison: S7 vs Modbus vs OPC UA

| Feature | S7 | Modbus | OPC UA |
|---------|----|---------| -------|
| Protocol Type | Proprietary | Open | Open |
| Addressing | Symbolic (DB1.DBD0) | Numeric (40001) | NodeID (ns=2;s=Tag) |
| Data Types | Native S7 types | 16-bit registers | Rich types |
| Subscription | Polling only | Polling only | Report-by-Exception |
| Security | Network-based | Network-based | Built-in (certificates) |
| Vendor Lock-in | Siemens only | Universal | Universal |

## Scaling Recommendations

| Device Count | Instances | Notes |
|--------------|-----------|-------|
| 1-50 PLCs | 1 gateway | Single instance sufficient |
| 50-200 PLCs | 2-4 gateways | Split by production line |
| 200+ PLCs | 5+ gateways | Split by plant/area |

## Troubleshooting

### Cannot Connect to PLC

```bash
# Check network connectivity
ping 192.168.1.50

# Check S7 port
nc -zv 192.168.1.50 102

# Verify PLC settings
# - PUT/GET enabled (S7-1200/1500)
# - Correct rack/slot
# - No firewall blocking
```

### Read Returns Wrong Values

1. Verify symbolic address syntax
2. Check data type matches PLC variable
3. Ensure DB is not optimized (S7-1200/1500)
4. Verify byte order (S7 uses big-endian)

### Write Operations Fail

1. Verify tag is writable (not Input area)
2. Check access mode is `readwrite` or `write`
3. Verify PUT/GET is enabled on PLC
4. Check value is within valid range

## Go Library

The S7 adapter uses [robinson/gos7](https://github.com/robinson/gos7), an MIT-licensed Go implementation of the S7 protocol.

```go
import "github.com/robinson/gos7"
```

**Features:**
- Pure Go implementation
- No external dependencies (no libnodave)
- Support for all S7 PLC families
- Thread-safe operations

