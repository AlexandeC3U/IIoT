# ğŸ—ï¸ NEXUS Edge Platform - Complete Architecture Graph

> **Industrial IoT Data Acquisition Platform** | Go + TypeScript | Edge-First Design

---

## ğŸ“Š System Overview

### Overview

The NEXUS Edge Platform is a comprehensive Industrial IoT data acquisition system designed with an **edge-first architecture**. It operates autonomously at the edge, with cloud connectivity being optional. The platform consists of five main layers: Presentation, Messaging, Processing, Ingestion, and Persistence.

**Key characteristics:**
- **Edge-First**: All critical functions work offline
- **Unified Namespace (UNS)**: Hierarchical MQTT topic structure for self-documenting data
- **Microservices**: Loosely coupled services communicating via MQTT
- **High Performance**: Go-based services for low latency and minimal memory footprint

```mermaid
flowchart TB
    subgraph Presentation["ğŸ–¥ï¸ PRESENTATION LAYER"]
        FE[NEXUS Control Center<br/>React :8080]
        NGINX[Nginx Reverse Proxy<br/>:80/:443]
        GW[Gateway Core<br/>Node.js :3000]
        GRAF[Grafana<br/>:3000]
    end

    subgraph Messaging["ğŸ“¨ MESSAGING LAYER"]
        EMQX[EMQX MQTT Broker<br/>100K connections<br/>:1883/:8883/:8083]
    end

    subgraph Processing["âš™ï¸ PROCESSING LAYER"]
        PG[Protocol Gateway<br/>Go :4000]
        FE_ENG[Flow Engine<br/>Node-RED :1880]
        ALERT[Alert Service<br/>Go :6000]
        ORCH[Orchestrator<br/>Go :5000]
    end

    subgraph Ingestion["ğŸ“¥ INGESTION LAYER"]
        DI[Data Ingestion<br/>Go :7000]
    end

    subgraph Persistence["ğŸ’¾ PERSISTENCE LAYER"]
        TSDB[(TimescaleDB<br/>Historian :5432)]
        PG_DB[(PostgreSQL<br/>Config :5433)]
    end

    subgraph OT["ğŸ­ OT NETWORK"]
        S7[Siemens S7<br/>PLCs]
        OPC[OPC UA<br/>Servers]
        MOD[Modbus<br/>Devices]
    end

    NGINX --> FE
    NGINX --> GW
    NGINX --> GRAF
    
    GW --> EMQX
    FE_ENG --> EMQX
    ALERT --> EMQX
    DI --> EMQX
    PG --> EMQX
    
    PG --> S7
    PG --> OPC
    PG --> MOD
    
    DI --> TSDB
    GW --> PG_DB
    GW --> TSDB
    GRAF --> TSDB

    style Presentation fill:#e1f5fe
    style Messaging fill:#fff3e0
    style Processing fill:#f3e5f5
    style Ingestion fill:#e8f5e9
    style Persistence fill:#fce4ec
    style OT fill:#f5f5f5
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                    NEXUS EDGE PLATFORM                                               â•‘
â•‘                           Industrial IoT Data Acquisition & Control                                  â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                      â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚                              PRESENTATION LAYER                                             â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â•‘
â•‘  â”‚  â”‚   NEXUS Control  â”‚  â”‚      Nginx       â”‚  â”‚     Gateway      â”‚  â”‚    Grafana       â”‚     â”‚     â•‘
â•‘  â”‚  â”‚   Center (React) â”‚  â”‚   Reverse Proxy  â”‚  â”‚       Core       â”‚  â”‚   (Optional)     â”‚     â”‚     â•‘
â•‘  â”‚  â”‚   Port: 8080     â”‚  â”‚   Port: 80/443   â”‚  â”‚   Port: 3000     â”‚  â”‚   Port: 3000     â”‚     â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘              â”‚                     â”‚                     â”‚                     â”‚                     â•‘
â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â•‘
â•‘                                               â”‚                                                      â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚                          MESSAGING LAYER   â”‚                                                 â”‚    â•‘
â•‘  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚    â•‘
â•‘  â”‚                    â”‚              EMQX MQTT BROKER                 â”‚                         â”‚    â•‘
â•‘  â”‚                    â”‚     High-Performance Message Bus (100K conn)  â”‚                         â”‚    â•‘
â•‘  â”‚                    â”‚                                               â”‚                         â”‚    â•‘
â•‘  â”‚                    â”‚   Ports: 1883 (TCP) | 8883 (SSL)              â”‚                         â”‚    â•‘
â•‘  â”‚                    â”‚          8083 (WS)  | 8084 (WSS)              â”‚                         â”‚    â•‘
â•‘  â”‚                    â”‚          18083 (Dashboard)                    â”‚                         â”‚    â•‘
â•‘  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘                                               â”‚                                                      â•‘
â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â•‘
â•‘                    â”‚                          â”‚                          â”‚                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚        PROCESSING LAYER            â”‚ â”‚   INGESTION LAYER     â”‚ â”‚    PERSISTENCE LAYER       â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â•‘
â•‘  â”‚  â”‚     Protocol Gateway       â”‚    â”‚ â”‚  â”‚  Data Ingestion â”‚  â”‚ â”‚  â”‚     TimescaleDB      â”‚  â”‚     â•‘
â•‘  â”‚  â”‚          (Go)              â”‚    â”‚ â”‚  â”‚      (Go)       â”‚  â”‚ â”‚  â”‚     (Historian)      â”‚  â”‚     â•‘
â•‘  â”‚  â”‚      Port: 4000            â”‚    â”‚ â”‚  â”‚   Port: 7000    â”‚  â”‚ â”‚  â”‚    Port: 5432        â”‚  â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â•‘
â•‘  â”‚  â”‚      Flow Engine           â”‚    â”‚                           â”‚  â”‚     PostgreSQL       â”‚  â”‚     â•‘
â•‘  â”‚  â”‚     (Node-RED)             â”‚    â”‚                           â”‚  â”‚   (Config Store)     â”‚  â”‚     â•‘
â•‘  â”‚  â”‚      Port: 1880            â”‚    â”‚                           â”‚  â”‚    Port: 5433        â”‚  â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘  â”‚  â”‚     Alert Service          â”‚    â”‚                                                              â•‘
â•‘  â”‚  â”‚         (Go)               â”‚    â”‚                                                              â•‘
â•‘  â”‚  â”‚      Port: 6000            â”‚    â”‚                                                              â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                              â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                                                              â•‘
â•‘  â”‚  â”‚     Orchestrator           â”‚    â”‚                                                              â•‘
â•‘  â”‚  â”‚     (Go/Docker)            â”‚    â”‚                                                              â•‘
â•‘  â”‚  â”‚      Port: 5000            â”‚    â”‚                                                              â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                                              â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                              â•‘
â•‘                                                                                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”Œ Protocol Gateway - Deep Architecture

### Overview

The **Protocol Gateway** is the heart of device communication, written in Go for maximum performance. It handles bidirectional communication with industrial devices using three major protocols: **Siemens S7**, **OPC UA**, and **Modbus**. 

**Core responsibilities:**
- **Polling Service**: Orchestrates interval-based polling with jitter distribution to prevent synchronized bursts
- **Command Handler**: Processes write commands from MQTT with rate limiting and back-pressure
- **Protocol Pools**: Manages connection pools with circuit breakers for fault tolerance

**Optimizations:**
- Worker pool with back-pressure (skips polls when overloaded)
- sync.Pool for DataPoint slices (reduces GC pressure)
- Circuit breaker pattern prevents cascade failures

```mermaid
flowchart TB
    subgraph Gateway["PROTOCOL GATEWAY SERVICE"]
        MAIN[main.go<br/>Application Entry]
        
        subgraph Services["Core Services"]
            PS[Polling Service<br/>â€¢ 10 Workers<br/>â€¢ Jitter Distribution<br/>â€¢ Back-pressure]
            CH[Command Handler<br/>â€¢ Rate Limit: 50<br/>â€¢ Queue: 1000<br/>â€¢ MQTT Subscribe]
            PM[Protocol Manager<br/>â€¢ Pool Routing<br/>â€¢ Thread-safe]
        end
        
        subgraph Pools["Connection Pools + Circuit Breakers"]
            MP[Modbus Pool<br/>Max: 100 conn<br/>goburrow/modbus]
            OP[OPC UA Pool<br/>Max: 50 conn<br/>gopcua/opcua]
            SP[S7 Pool<br/>Max: 100 conn<br/>robinson/gos7]
        end
        
        subgraph Background["Background Workers"]
            HC[Health Check Loop<br/>30s interval]
            IR[Idle Reaper Loop<br/>5min timeout]
        end
        
        PUB[MQTT Publisher<br/>PublishBatch]
    end

    MAIN --> PS
    MAIN --> CH
    MAIN --> PM
    
    PS --> PM
    CH --> PM
    PM --> MP
    PM --> OP
    PM --> SP
    
    MP --> HC
    OP --> HC
    SP --> HC
    MP --> IR
    OP --> IR
    SP --> IR
    
    PS --> PUB

    style Gateway fill:#f3e5f5
    style Services fill:#e8f5e9
    style Pools fill:#fff3e0
    style Background fill:#e3f2fd
```

```mermaid
sequenceDiagram
    participant Device as Field Device
    participant Pool as Protocol Pool
    participant CB as Circuit Breaker
    participant PS as Polling Service
    participant MQTT as EMQX Broker

    loop Every Poll Interval + Jitter
        PS->>PS: Acquire Worker (non-blocking)
        alt Worker Available
            PS->>Pool: ReadTags(device, tags)
            Pool->>CB: Execute(read)
            alt Circuit Closed
                CB->>Device: Protocol Request
                Device-->>CB: Response
                CB-->>Pool: DataPoints
                Pool-->>PS: DataPoints
                PS->>PS: Apply Scaling/Quality
                PS->>MQTT: PublishBatch(datapoints)
            else Circuit Open
                CB-->>Pool: ErrCircuitBreakerOpen
                Pool-->>PS: Error (fast-fail)
            end
        else All Workers Busy
            PS->>PS: Skip poll (back-pressure)
            PS->>PS: Increment SkippedPolls
        end
    end
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              PROTOCOL GATEWAY SERVICE (Go)                                          â•‘
â•‘                                  High-Performance Device I/O                                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚                                    MAIN APPLICATION                                        â”‚     â•‘
â•‘  â”‚                                       cmd/gateway/main.go                                  â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                â”‚                                                    â•‘
â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â•‘
â•‘              â”‚                                 â”‚                                 â”‚                  â•‘
â•‘              â–¼                                 â–¼                                 â–¼                  â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘  â”‚    POLLING SERVICE    â”‚     â”‚     COMMAND HANDLER       â”‚     â”‚    PROTOCOL MANAGER   â”‚          â•‘
â•‘  â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚     â”‚     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       â”‚     â”‚    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚          â•‘
â•‘  â”‚                       â”‚     â”‚                           â”‚     â”‚                       â”‚          â•‘
â•‘  â”‚  â€¢ Device orchestratorâ”‚     â”‚  â€¢ MQTT cmd subscriber    â”‚     â”‚  â€¢ Protocol routing   â”‚          â•‘
â•‘  â”‚  â€¢ Interval-based pollâ”‚     â”‚  â€¢ Write request handler  â”‚     â”‚  â€¢ Pool management    â”‚          â•‘
â•‘  â”‚  â€¢ Jitter distributionâ”‚     â”‚  â€¢ Rate limiting (50 max) â”‚     â”‚  â€¢ Thread-safe access â”‚          â•‘
â•‘  â”‚  â€¢ Back-pressure ctrl â”‚     â”‚  â€¢ Bounded queue (1000)   â”‚     â”‚                       â”‚          â•‘
â•‘  â”‚                       â”‚     â”‚  â€¢ Response publishing    â”‚     â”‚  RegisteredProtocols: â”‚          â•‘
â•‘  â”‚  PollingConfig:       â”‚     â”‚                           â”‚     â”‚  â€¢ MODBUS             â”‚          â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  CommandConfig:           â”‚     â”‚  â€¢ OPC_UA             â”‚          â•‘
â•‘  â”‚  â”‚ WorkerCount: 10 â”‚  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â€¢ S7                 â”‚          â•‘
â•‘  â”‚  â”‚ BatchSize: 50   â”‚  â”‚     â”‚  â”‚ MaxConcurrentWrites â”‚  â”‚     â”‚                       â”‚          â•‘
â•‘  â”‚  â”‚ Interval: 1s    â”‚  â”‚     â”‚  â”‚      = 50           â”‚  â”‚     â”‚  Interface:           â”‚          â•‘
â•‘  â”‚  â”‚ Retries: 3      â”‚  â”‚     â”‚  â”‚ QueueSize = 1000    â”‚  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â•‘
â•‘  â”‚  â”‚ Shutdown: 30s   â”‚  â”‚     â”‚  â”‚ WriteTimeout: 10s   â”‚  â”‚     â”‚  â”‚ ReadTags()      â”‚  â”‚          â•‘   
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â”‚  â”‚ ReadTag()       â”‚  â”‚          â•‘
â•‘  â”‚                       â”‚     â”‚                           â”‚     â”‚  â”‚ WriteTag()      â”‚  â”‚          â•‘
â•‘  â”‚  Stats Tracking:      â”‚     â”‚  Stats:                   â”‚     â”‚  â”‚ Close()         â”‚  â”‚          â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚     â”‚  â”‚ HealthCheck()   â”‚  â”‚          â•‘
â•‘  â”‚  â”‚ TotalPolls      â”‚  â”‚     â”‚  â”‚ CommandsReceived    â”‚  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â•‘
â•‘  â”‚  â”‚ SuccessPolls    â”‚  â”‚     â”‚  â”‚ CommandsSucceeded   â”‚  â”‚     â”‚                       â”‚          â•‘
â•‘  â”‚  â”‚ FailedPolls     â”‚  â”‚     â”‚  â”‚ CommandsFailed      â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
â•‘  â”‚  â”‚ SkippedPolls    â”‚  â”‚     â”‚  â”‚ CommandsRejected    â”‚  â”‚                 â”‚                      â•‘ 
â•‘  â”‚  â”‚ PointsRead      â”‚  â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                 â”‚                      â•‘
â•‘  â”‚  â”‚ PointsPublished â”‚  â”‚     â”‚                           â”‚                 â”‚                      â•‘ 
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚                      â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚                               â”‚                      â•‘
â•‘              â”‚                               â”‚                               â”‚                      â•‘
â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â•‘
â•‘                                              â”‚                                                      â•‘
â•‘                                              â–¼                                                      â•‘
â•‘  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â•‘
â•‘  â•‘                                   PROTOCOL POOLS                                             â•‘   â•‘
â•‘  â•‘                       Connection Pooling + Circuit Breaker Pattern                           â•‘   â•‘
â•‘  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â•‘
â•‘  â•‘                                                                                              â•‘   â•‘
â•‘  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘   â•‘
â•‘  â•‘  â”‚      MODBUS POOL           â”‚ â”‚       OPC UA POOL          â”‚ â”‚         S7 POOL            â”‚â•‘   â•‘
â•‘  â•‘  â”‚      â•â•â•â•â•â•â•â•â•â•            â”‚ â”‚       â•â•â•â•â•â•â•â•â•â•           â”‚ â”‚         â•â•â•â•â•â•â•            â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚                            â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â”‚  Library: goburrow/modbus  â”‚ â”‚  Library: gopcua/opcua     â”‚ â”‚  Library: robinson/gos7    â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚                            â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â”‚  PoolConfig:               â”‚ â”‚  PoolConfig:               â”‚ â”‚  PoolConfig:               â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ MaxConn: 100       â”‚    â”‚ â”‚  â”‚ MaxConn: 50        â”‚    â”‚ â”‚  â”‚ MaxConn: 100       â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ IdleTimeout: 5min  â”‚    â”‚ â”‚  â”‚ IdleTimeout: 5min  â”‚    â”‚ â”‚  â”‚ IdleTimeout: 5min  â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ HealthCheck: 30s   â”‚    â”‚ â”‚  â”‚ HealthCheck: 30s   â”‚    â”‚ â”‚  â”‚ HealthCheck: 30s   â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ ConnTimeout: 10s   â”‚    â”‚ â”‚  â”‚ ConnTimeout: 15s   â”‚    â”‚ â”‚  â”‚ ConnTimeout: 10s   â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ RetryAttempts: 3   â”‚    â”‚ â”‚  â”‚ RetryAttempts: 3   â”‚    â”‚ â”‚  â”‚ RetryAttempts: 3   â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ RetryDelay: 100ms  â”‚    â”‚ â”‚  â”‚ RetryDelay: 500ms  â”‚    â”‚ â”‚  â”‚ RetryDelay: 100ms  â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚                            â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â”‚  Circuit Breaker:          â”‚ â”‚  Circuit Breaker:          â”‚ â”‚  Circuit Breaker:          â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ MaxRequests: 3     â”‚    â”‚ â”‚  â”‚ MaxRequests: 3     â”‚    â”‚ â”‚  â”‚ MaxRequests: 3     â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ Interval: 10s      â”‚    â”‚ â”‚  â”‚ Interval: 10s      â”‚    â”‚ â”‚  â”‚ Interval: 10s      â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ Timeout: 30s       â”‚    â”‚ â”‚  â”‚ Timeout: 60s       â”‚    â”‚ â”‚  â”‚ Timeout: 30s       â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ FailRatio: 60%     â”‚    â”‚ â”‚  â”‚ FailRatio: 60%     â”‚    â”‚ â”‚  â”‚ FailRatio: 50%     â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â”‚ MinRequests: 10    â”‚    â”‚ â”‚  â”‚ MinRequests: 5     â”‚    â”‚ â”‚  â”‚ MinRequests: 5     â”‚    â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚                            â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â”‚  Background Workers:       â”‚ â”‚  Background Workers:       â”‚ â”‚  Background Workers:       â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â€¢ healthCheckLoop()       â”‚ â”‚  â€¢ healthCheckLoop()       â”‚ â”‚  â€¢ healthCheckLoop()       â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â€¢ idleReaperLoop()        â”‚ â”‚  â€¢ idleReaperLoop()        â”‚ â”‚  â€¢ checkConnections()      â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚                            â”‚ â”‚  â€¢ evictIdleConnection()   â”‚â•‘   â•‘
â•‘  â•‘  â”‚  Supported Function Codes: â”‚ â”‚  Features:                 â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â€¢ FC01/02 (Read Coils)    â”‚ â”‚  â€¢ Browse Address Space    â”‚ â”‚  Supported PLCs:           â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â€¢ FC03/04 (Read Regs)     â”‚ â”‚  â€¢ MonitoredItems Subs     â”‚ â”‚  â€¢ S7-300/400 (Classic)    â”‚â•‘   â•‘ 
â•‘  â•‘  â”‚  â€¢ FC05/06 (Write Single)  â”‚ â”‚  â€¢ Security: None/Sign/Enc â”‚ â”‚  â€¢ S7-1200 (Optimized)     â”‚â•‘   â•‘
â•‘  â•‘  â”‚  â€¢ FC15/16 (Write Multi)   â”‚ â”‚  â€¢ Auth: Anon/User/Cert    â”‚ â”‚  â€¢ S7-1500 (Optimized)     â”‚â•‘   â•‘
â•‘  â•‘  â”‚                            â”‚ â”‚  â€¢ WriteRequest Support    â”‚ â”‚                            â”‚â•‘   â•‘
â•‘  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘   â•‘
â•‘  â•‘                                                                                              â•‘   â•‘
â•‘  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                      MQTT PUBLISHER                                          â”‚   â•‘
â•‘  â”‚  â€¢ QoS selection (0, 1, 2)                                                                   â”‚   â•‘
â•‘  â”‚  â€¢ Batch publishing (PublishBatch)                                                           â”‚   â•‘
â•‘  â”‚  â€¢ Topic mapping: {enterprise}/{site}/{area}/{line}/{device}/{datapoint}                     â”‚   â•‘
â•‘  â”‚  â€¢ Automatic reconnection                                                                    â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“¥ Data Ingestion Service - Deep Architecture

### Overview

The **Data Ingestion Service** is a high-throughput pipeline that moves data from MQTT to TimescaleDB. Written in Go, it's optimized for processing hundreds of thousands of data points per second.

**Pipeline stages:**
1. **MQTT Subscriber**: Subscribes to UNS topics, parses JSON/SparkplugB messages
2. **Points Channel**: 10,000-capacity buffer with non-blocking back-pressure
3. **Batcher**: Accumulates points into batches (1000 points or 100ms flush)
4. **Writer Pool**: 4 parallel writers using PostgreSQL COPY protocol

**Key optimizations:**
- **COPY FROM STDIN**: 10-100x faster than individual INSERTs
- **Batch object pooling**: Reuses batch containers to reduce GC
- **Non-blocking channels**: Drops data gracefully under extreme load

```mermaid
flowchart LR
    subgraph MQTT["MQTT Layer"]
        SUB[MQTT Subscriber<br/>Topic: +/#<br/>QoS: 1]
    end

    subgraph Buffer["Buffer Layer"]
        PC[Points Channel<br/>Capacity: 10,000<br/>Non-blocking]
    end

    subgraph Batcher["Batching Layer"]
        ACC[Accumulator Loop<br/>â€¢ Size trigger: 1000<br/>â€¢ Time trigger: 100ms]
        BC[Batch Channel<br/>Capacity: 8]
    end

    subgraph Writers["Writer Pool"]
        W0[Writer 0]
        W1[Writer 1]
        W2[Writer 2]
        W3[Writer 3]
    end

    subgraph DB["TimescaleDB"]
        HT[(metrics<br/>Hypertable)]
    end

    SUB -->|"parse &<br/>push"| PC
    PC -->|drain| ACC
    ACC -->|"flush<br/>batch"| BC
    BC --> W0
    BC --> W1
    BC --> W2
    BC --> W3
    W0 -->|"COPY<br/>protocol"| HT
    W1 -->|"COPY<br/>protocol"| HT
    W2 -->|"COPY<br/>protocol"| HT
    W3 -->|"COPY<br/>protocol"| HT

    style MQTT fill:#fff3e0
    style Buffer fill:#e8f5e9
    style Batcher fill:#e3f2fd
    style Writers fill:#f3e5f5
    style DB fill:#fce4ec
```

```mermaid
sequenceDiagram
    participant MQTT as EMQX Broker
    participant Sub as MQTT Subscriber
    participant Chan as Points Channel
    participant Acc as Accumulator
    participant BC as Batch Channel
    participant Writer as Writer Pool
    participant DB as TimescaleDB

    MQTT->>Sub: Message (topic, payload)
    Sub->>Sub: ParseMessage()
    
    alt Channel has capacity
        Sub->>Chan: Push DataPoint
    else Channel full (back-pressure)
        Sub->>Sub: Drop & increment pointsDropped
    end

    loop Accumulator Loop
        Chan->>Acc: Drain points
        Acc->>Acc: Add to current batch
        
        alt Batch full (1000) OR Timer (100ms)
            Acc->>BC: Flush batch
            Acc->>Acc: AcquireBatch() from pool
        end
    end

    loop Writer Loop (x4)
        BC->>Writer: Get batch
        Writer->>DB: BEGIN
        Writer->>DB: COPY FROM STDIN
        Writer->>DB: COMMIT
        Writer->>Writer: ReleaseBatch() to pool
    end
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              DATA INGESTION SERVICE (Go)                                            â•‘
â•‘                           High-Throughput MQTT â†’ TimescaleDB Pipeline                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                   INGESTION SERVICE                                          â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  IngestionConfig:                                                                            â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â•‘
â•‘  â”‚  â”‚  BufferSize: 10000       â”‚  BatchSize: 1000       â”‚  FlushInterval: 100ms           â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  WriterCount: 4          â”‚                        â”‚                                 â”‚     â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                               â”‚                                                     â•‘
â•‘         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â•‘
â•‘         â”‚                                     â”‚                                     â”‚               â•‘
â•‘         â–¼                                     â–¼                                     â–¼               â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚   MQTT SUBSCRIBER  â”‚            â”‚   POINTS CHANNEL     â”‚            â”‚     BATCHER            â”‚   â•‘
â•‘  â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â•â•â•â•â•â•â•            â”‚   â•‘
â•‘  â”‚                    â”‚   push     â”‚                      â”‚   drain    â”‚                        â”‚   â•‘
â•‘  â”‚  â€¢ Topic: +/#      â”‚            â”‚  Buffered Chan       â”‚            â”‚  BatcherConfig:        â”‚   â•‘
â•‘  â”‚  â€¢ QoS: 1          â”‚            â”‚  Cap: 10000          â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚  â€¢ HandleMessage() â”‚            â”‚                      â”‚            â”‚  â”‚ BatchSize: 1000  â”‚  â”‚   â•‘
â•‘  â”‚                    â”‚            â”‚  Back-pressure:      â”‚            â”‚  â”‚ FlushInterval:   â”‚  â”‚   â•‘
â•‘  â”‚  ParseMessage:     â”‚            â”‚  Non-blocking send   â”‚            â”‚  â”‚   100ms          â”‚  â”‚   â•‘
â•‘  â”‚  â€¢ JSON decode     â”‚            â”‚  Drop on full        â”‚            â”‚  â”‚ WriterCount: 4   â”‚  â”‚   â•‘
â•‘  â”‚  â€¢ SparkplugB      â”‚            â”‚  Track pointsDropped â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                    â”‚            â”‚                      â”‚            â”‚                        â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  Workers:              â”‚   â•‘
â•‘                                                                        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘                                                                        â”‚  â”‚ accumulatorLoop  â”‚  â”‚   â•‘
â•‘                                                                        â”‚  â”‚ writerLoop(0)    â”‚  â”‚   â•‘
â•‘                                                                        â”‚  â”‚ writerLoop(1)    â”‚  â”‚   â•‘
â•‘                                                                        â”‚  â”‚ writerLoop(2)    â”‚  â”‚   â•‘
â•‘                                                                        â”‚  â”‚ writerLoop(3)    â”‚  â”‚   â•‘
â•‘                                                                        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘                                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                    â”‚                â•‘
â•‘                                                                                    â–¼                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                   BATCH CHANNEL                                              â”‚   â•‘
â•‘  â”‚                              Completed batches waiting for write                             â”‚   â•‘
â•‘  â”‚                                  Capacity: WriterCount * 2 = 8                               â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                               â”‚                                                     â•‘
â•‘                                               â–¼                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                  TIMESCALEDB WRITER                                          â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  WriteBatch():                                                                               â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚  â”‚  1. Acquire connection from pgx pool                                                   â”‚  â”‚   â•‘
â•‘  â”‚  â”‚  2. Begin transaction                                                                  â”‚  â”‚   â•‘
â•‘  â”‚  â”‚  3. COPY FROM STDIN (bulk insert)  â—„â”€â”€â”€ Optimized for high throughput                  â”‚  â”‚   â•‘
â•‘  â”‚  â”‚  4. Commit transaction                                                                 â”‚  â”‚   â•‘
â•‘  â”‚  â”‚  5. Return connection to pool                                                          â”‚  â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Target Table: metrics (hypertable)                                                          â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚  â”‚  time TIMESTAMPTZ â”‚ topic TEXT â”‚ value DOUBLE â”‚ value_str TEXT â”‚ quality SMALLINT      â”‚  â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”„ Data Flow - Complete Pipeline

### Overview

The complete data flow demonstrates how industrial data moves from field devices to persistent storage and real-time consumers. The architecture follows the **Unified Namespace (UNS)** pattern where all data flows through a central MQTT broker with a hierarchical topic structure.

**Data flow path:**
1. **Field Devices** â†’ Protocol-specific communication (S7/OPC UA/Modbus)
2. **Protocol Gateway** â†’ Reads, transforms, publishes to MQTT
3. **EMQX Broker** â†’ Central message bus with UNS topics
4. **Multiple Consumers** â†’ Data Ingestion, Flow Engine, Alert Service, Frontend

**UNS Topic Structure:**
```
{enterprise}/{site}/{area}/{line}/{device}/{datapoint}
Example: acme/plant-chicago/building-a/line-1/plc-001/temperature
```

```mermaid
flowchart TB
    subgraph OT["ğŸ­ OT NETWORK"]
        S7[Siemens S7-1500<br/>TCP/102]
        OPC[OPC UA Server<br/>TCP/4840]
        MOD[Modbus Gateway<br/>TCP/502]
        SENS[Sensors/Actuators]
    end

    subgraph Gateway["PROTOCOL GATEWAY"]
        S7P[S7 Pool<br/>+ Circuit Breaker]
        OPCP[OPC UA Pool<br/>+ Circuit Breaker]
        MODP[Modbus Pool<br/>+ Circuit Breaker]
        POLL[Polling Service<br/>10 Workers]
        DPP[DataPoint Pool<br/>sync.Pool cap:64]
        PUB[MQTT Publisher<br/>PublishBatch]
    end

    subgraph Broker["EMQX BROKER"]
        UNS["Unified Namespace<br/>{enterprise}/{site}/{area}/{line}/{device}/{tag}"]
    end

    subgraph Consumers["CONSUMERS"]
        DI[Data Ingestion<br/>â†’ TimescaleDB]
        FE[Flow Engine<br/>Node-RED]
        AS[Alert Service<br/>Rule Evaluation]
        WS[WebSocket Bridge<br/>â†’ Frontend]
    end

    subgraph Storage["PERSISTENCE"]
        TSDB[(TimescaleDB<br/>metrics hypertable)]
        AGG[Continuous Aggregates<br/>1min/1hour/1day]
    end

    S7 --> S7P
    OPC --> OPCP
    MOD --> MODP
    SENS --> MOD

    S7P --> POLL
    OPCP --> POLL
    MODP --> POLL
    
    POLL --> DPP
    DPP --> PUB
    PUB --> UNS

    UNS --> DI
    UNS --> FE
    UNS --> AS
    UNS --> WS

    DI --> TSDB
    TSDB --> AGG

    style OT fill:#f5f5f5
    style Gateway fill:#e8f5e9
    style Broker fill:#fff3e0
    style Consumers fill:#e3f2fd
    style Storage fill:#fce4ec
```

```mermaid
sequenceDiagram
    participant PLC as Field Device
    participant Pool as Protocol Pool
    participant Poll as Polling Service
    participant MQTT as EMQX Broker
    participant Ingestion as Data Ingestion
    participant DB as TimescaleDB

    Note over PLC,DB: Read Flow (every poll interval)
    
    Poll->>Pool: ReadTags(device, tags)
    Pool->>PLC: Protocol Request
    PLC-->>Pool: Raw Values
    Pool-->>Poll: DataPoints[]
    
    Poll->>Poll: Set topic from UNS prefix
    Poll->>Poll: Apply scaling if configured
    Poll->>Poll: Set quality flags
    
    Poll->>MQTT: PublishBatch(datapoints)
    
    par Parallel Consumers
        MQTT->>Ingestion: Message (topic, payload)
        Ingestion->>Ingestion: Buffer â†’ Batch
        Ingestion->>DB: COPY batch
    and
        MQTT->>Note: Flow Engine processes
    and
        MQTT->>Note: Alert Service evaluates
    end
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                    COMPLETE DATA FLOW                                               â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚                               OT NETWORK / FIELD DEVICES                                    â”‚    â•‘
â•‘  â”‚                                                                                             â”‚    â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚    â•‘
â•‘  â”‚   â”‚  Siemens    â”‚    â”‚   Beckhoff  â”‚    â”‚   Schneider â”‚    â”‚   Generic   â”‚                  â”‚    â•‘
â•‘  â”‚   â”‚  S7-1500    â”‚    â”‚  OPC UA     â”‚    â”‚   Modbus    â”‚    â”‚   Sensors   â”‚                  â”‚    â•‘
â•‘  â”‚   â”‚  PLC        â”‚    â”‚  Server     â”‚    â”‚   Gateway   â”‚    â”‚             â”‚                  â”‚    â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚    â•‘
â•‘  â”‚          â”‚                  â”‚                  â”‚                  â”‚                         â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•‘             â”‚ TCP/102          â”‚ TCP/4840         â”‚ TCP/502          â”‚                              â•‘
â•‘             â”‚ S7 Protocol      â”‚ OPC UA           â”‚ Modbus TCP       â”‚                              â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚                              â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•‘
â•‘             â”‚                  â”‚                  â”‚                  â”‚                              â•‘
â•‘             â–¼                  â–¼                  â–¼                  â–¼                              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                PROTOCOL GATEWAY                                              â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚   â•‘
â•‘  â”‚  â”‚    S7 Pool      â”‚  â”‚   OPC UA Pool   â”‚  â”‚   Modbus Pool   â”‚                               â”‚   â•‘
â•‘  â”‚  â”‚   (gos7)        â”‚  â”‚   (gopcua)      â”‚  â”‚   (go-modbus)   â”‚                               â”‚   â•‘
â•‘  â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚                               â”‚   â•‘
â•‘  â”‚  â”‚  Circuit        â”‚  â”‚  Circuit        â”‚  â”‚  Circuit        â”‚                               â”‚   â•‘
â•‘  â”‚  â”‚  Breaker        â”‚  â”‚  Breaker        â”‚  â”‚  Breaker        â”‚                               â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â•‘
â•‘  â”‚           â”‚                    â”‚                    â”‚                                        â”‚   â•‘
â•‘  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚   â•‘
â•‘  â”‚                                â–¼                                                             â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â•‘
â•‘  â”‚  â”‚                    POLLING SERVICE                               â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚                                                                  â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    Worker Pool (10)  â†â”€â”€â”                                        â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚         â”‚               â”‚ Back-pressure: Skip poll if busy       â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚         â–¼               â”‚                                        â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”‚ Device Pollers (per device goroutine)                   â”‚   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”‚                                                         â”‚   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”‚  â€¢ Jitter: 0-10% of interval (spread polls over time)   â”‚   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”‚  â€¢ Ticker-based scheduling                              â”‚   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â”‚  â€¢ Timeout: device.Connection.Timeout                   â”‚   â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                        â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â•‘
â•‘  â”‚                                â”‚                                                             â”‚   â•‘
â•‘  â”‚                                â–¼                                                             â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â•‘
â•‘  â”‚  â”‚                    DataPoint Pool (sync.Pool)                    â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚                    Pre-allocated slices, cap: 64                 â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚                    Reduces GC pressure                           â”‚                        â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â•‘
â•‘  â”‚                                   â”‚                                                          â”‚   â•‘
â•‘  â”‚                                   â–¼                                                          â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â•‘
â•‘  â”‚  â”‚                    MQTT PUBLISHER                                â”‚                        â”‚   â•‘
â•‘  â”‚  â”‚                    PublishBatch() for efficiency                 â”‚                        â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â•‘
â•‘  â”‚                                   â”‚                                                          â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                      â”‚                                                              â•‘
â•‘                                      â”‚  Topic: {uns_prefix}/{topic_suffix}                          â•‘
â•‘                                      â”‚  Example: acme/plant-1/line-1/plc-001/temperature            â•‘
â•‘                                      â–¼                                                              â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                    EMQX BROKER                                               â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â•‘
â•‘  â”‚   â”‚  Unified Namespace (UNS)                                                            â”‚    â”‚   â•‘
â•‘  â”‚   â”‚  {enterprise}/{site}/{area}/{line}/{device}/{datapoint}                             â”‚    â”‚   â•‘
â•‘  â”‚   â”‚                                                                                     â”‚    â”‚   â•‘
â•‘  â”‚   â”‚  Examples:                                                                          â”‚    â”‚   â•‘
â•‘  â”‚   â”‚  â€¢ acme/plant-chicago/building-a/line-1/plc-001/temperature                         â”‚    â”‚   â•‘
â•‘  â”‚   â”‚  â€¢ acme/plant-chicago/building-a/line-1/sensor-temp-01/value                        â”‚    â”‚   â•‘
â•‘  â”‚   â”‚  â€¢ acme/plant-chicago/building-a/line-2/robot-arm/position/x                        â”‚    â”‚   â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚   Subscribers:                                                                               â”‚   â•‘
â•‘  â”‚   â€¢ Data Ingestion Service (historian)                                                       â”‚   â•‘
â•‘  â”‚   â€¢ Flow Engine (processing)                                                                 â”‚   â•‘
â•‘  â”‚   â€¢ Alert Service (monitoring)                                                               â”‚   â•‘
â•‘  â”‚   â€¢ Frontend (WebSocket bridge)                                                              â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                        â”‚                                                            â•‘
â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â•‘
â•‘              â”‚                         â”‚                         â”‚                                  â•‘
â•‘              â–¼                         â–¼                         â–¼                                  â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â•‘
â•‘  â”‚  DATA INGESTION    â”‚   â”‚    FLOW ENGINE     â”‚   â”‚    ALERT SERVICE       â”‚                       â•‘
â•‘  â”‚                    â”‚   â”‚                    â”‚   â”‚                        â”‚                       â•‘
â•‘  â”‚  Batcher â†’         â”‚   â”‚  MQTT In â†’         â”‚   â”‚  Rule Evaluation â†’     â”‚                       â•‘
â•‘  â”‚  WriterPool â†’      â”‚   â”‚  Transform â†’       â”‚   â”‚  Threshold Check â†’     â”‚                       â•‘
â•‘  â”‚  TimescaleDB       â”‚   â”‚  MQTT Out          â”‚   â”‚  Notification          â”‚                       â•‘
â•‘  â”‚                    â”‚   â”‚                    â”‚   â”‚                        â”‚                       â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â•‘
â•‘            â”‚                                                                                        â•‘
â•‘            â–¼                                                                                        â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚                                    TIMESCALEDB                                               â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚   Hypertable: metrics                                                                        â”‚   â•‘
â•‘  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚   â”‚  time TIMESTAMPTZ â”‚ topic TEXT â”‚ value DOUBLE â”‚ quality SMALLINT â”‚ metadata JSONB     â”‚  â”‚   â•‘
â•‘  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚   Continuous Aggregates:                                                                     â”‚   â•‘
â•‘  â”‚   â€¢ metrics_1min   (1-minute rollups)                                                        â”‚   â•‘
â•‘  â”‚   â€¢ metrics_1hour  (1-hour rollups)                                                          â”‚   â•‘
â•‘  â”‚   â€¢ metrics_1day   (1-day rollups)                                                           â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚   Policies:                                                                                  â”‚   â•‘
â•‘  â”‚   â€¢ Compression: After 7 days                                                                â”‚   â•‘
â•‘  â”‚   â€¢ Retention: Raw=30d, Hourly=1y, Daily=5y                                                  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ Command Flow (Bidirectional Control)

### Overview

The **Command Handler** enables bidirectional control by processing write commands received via MQTT. This allows applications, the frontend, or the Flow Engine to write values back to field devices.

**Command topics:**
- `$nexus/cmd/{device_id}/write` - JSON payload with tag_id and value
- `$nexus/cmd/{device_id}/{tag_id}/set` - Direct value on topic

**Protection mechanisms:**
1. **Bounded Queue (1000)**: Prevents memory exhaustion under load
2. **Write Semaphore (50)**: Limits concurrent writes to devices
3. **Validation**: Checks device/tag existence and writability
4. **Circuit Breaker**: Fast-fails for known-bad connections

**Response flow:**
All commands receive an acknowledgement on `$nexus/cmd/response/{device_id}/{tag_id}` with success/failure status and timing information.

```mermaid
flowchart TB
    subgraph Sources["Command Sources"]
        APP[Application]
        UI[Frontend UI]
        FE[Flow Engine]
    end

    subgraph Handler["COMMAND HANDLER"]
        SUB[MQTT Subscriber<br/>$nexus/cmd/+/write<br/>$nexus/cmd/+/+/set]
        Q[Bounded Queue<br/>Capacity: 1000]
        SEM[Write Semaphore<br/>Max: 50 concurrent]
        VAL[Validator<br/>â€¢ Device exists?<br/>â€¢ Tag exists?<br/>â€¢ Tag writable?]
        PROC[processCommandQueue<br/>Single goroutine]
    end

    subgraph Pools["Protocol Pools"]
        MP[Modbus Pool]
        OP[OPC UA Pool]
        SP[S7 Pool]
    end

    subgraph Devices["Field Devices"]
        DEV[PLCs / Gateways]
    end

    subgraph Response["Response"]
        RESP[MQTT Publish<br/>$nexus/cmd/response/{device}/{tag}]
    end

    APP -->|publish| SUB
    UI -->|publish| SUB
    FE -->|publish| SUB

    SUB -->|"non-blocking<br/>enqueue"| Q
    Q --> PROC
    PROC -->|acquire| SEM
    SEM --> VAL
    VAL -->|WriteTag| MP
    VAL -->|WriteTag| OP
    VAL -->|WriteTag| SP
    
    MP --> DEV
    OP --> DEV
    SP --> DEV

    DEV -->|result| RESP

    style Sources fill:#e8f5e9
    style Handler fill:#fff3e0
    style Pools fill:#e3f2fd
    style Response fill:#f3e5f5
```

```mermaid
sequenceDiagram
    participant App as Application
    participant MQTT as EMQX Broker
    participant CH as Command Handler
    participant Q as Command Queue
    participant Sem as Semaphore
    participant PM as Protocol Manager
    participant Dev as Field Device

    App->>MQTT: Publish $nexus/cmd/plc-001/write<br/>{"tag_id":"temp","value":75.5}
    MQTT->>CH: handleWriteCommand()
    
    alt Queue has capacity
        CH->>Q: Enqueue command (non-blocking)
    else Queue full
        CH->>MQTT: Response: "queue full"
        Note right of CH: Back-pressure applied
    end

    loop processCommandQueue
        Q->>CH: Dequeue command
        
        alt Semaphore available
            CH->>Sem: Acquire (non-blocking)
            CH->>CH: Validate device & tag
            
            alt Validation passed
                CH->>PM: WriteTag(device, tag, value)
                PM->>Dev: Protocol write request
                Dev-->>PM: Success/Error
                PM-->>CH: Result
                CH->>MQTT: Response: success=true
            else Validation failed
                CH->>MQTT: Response: "tag not writable"
            end
            
            Sem->>CH: Release
        else Semaphore full
            CH->>MQTT: Response: "rate limit exceeded"
        end
    end
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                               WRITE COMMAND FLOW (Bidirectional)                                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  APPLICATION / FRONTEND / FLOW ENGINE                                                       â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚  Publish to: $nexus/cmd/{device_id}/write                                                   â”‚   â•‘
â•‘   â”‚              $nexus/cmd/{device_id}/{tag_id}/set                                            â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚  Payload: {"tag_id": "temp", "value": 75.5, "request_id": "abc123"}                         â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                â”‚                                                    â•‘
â•‘                                                â–¼                                                    â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                              COMMAND HANDLER                                                â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â•‘
â•‘   â”‚   â”‚  1. MQTT Message Received                                                           â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     handleWriteCommand() or handleTagWriteCommand()                                 â”‚   â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â•‘
â•‘   â”‚                                           â”‚                                                 â”‚   â•‘
â•‘   â”‚                                           â–¼                                                 â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â•‘
â•‘   â”‚   â”‚  2. Queue Command (non-blocking, bounded queue: 1000)                               â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     Back-pressure: Reject with "queue full" if capacity reached                     â”‚   â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â•‘
â•‘   â”‚                                           â”‚                                                 â”‚   â•‘
â•‘   â”‚                                           â–¼                                                 â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â•‘
â•‘   â”‚   â”‚  3. processCommandQueue() - Single goroutine processes queue                        â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     Acquire semaphore (max 50 concurrent writes)                                    â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     Rate limit: Reject with "rate limit exceeded" if semaphore full                 â”‚   â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â•‘
â•‘   â”‚                                           â”‚                                                 â”‚   â•‘
â•‘   â”‚                                           â–¼                                                 â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â•‘
â•‘   â”‚   â”‚  4. Validate                                                                        â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     â€¢ Device exists?                                                                â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     â€¢ Tag exists?                                                                   â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     â€¢ Tag writable? (tag.IsWritable())                                              â”‚   â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â•‘
â•‘   â”‚                                           â”‚                                                 â”‚   â•‘
â•‘   â”‚                                           â–¼                                                 â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â•‘
â•‘   â”‚   â”‚  5. Execute Write via Protocol Manager                                              â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     protocolManager.WriteTag(ctx, device, tag, value)                               â”‚   â”‚   â•‘
â•‘   â”‚   â”‚     Timeout: 10s (configurable)                                                     â”‚   â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                â”‚                                                    â•‘
â•‘                                                â–¼                                                    â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                              PROTOCOL POOLS                                                 â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â•‘
â•‘   â”‚   â”‚  Modbus Pool     â”‚    â”‚  OPC UA Pool     â”‚    â”‚    S7 Pool       â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚                  â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚  WriteTag()      â”‚    â”‚  WriteTag()      â”‚    â”‚  WriteTag()      â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚  WriteSingleCoil â”‚    â”‚  WriteTags()     â”‚    â”‚  WriteTags()     â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚  WriteSingle     â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚    Register      â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚  WriteMultiple   â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚    Registers     â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚  WriteMultiple   â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â”‚    Coils         â”‚    â”‚                  â”‚    â”‚                  â”‚                      â”‚   â•‘
â•‘   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â•‘
â•‘   â”‚            â”‚                       â”‚                       â”‚                                â”‚   â•‘
â•‘   â”‚            â”‚    Circuit Breaker    â”‚    Circuit Breaker    â”‚    Circuit Breaker             â”‚   â•‘
â•‘   â”‚            â”‚    Protection         â”‚    Protection         â”‚    Protection                  â”‚   â•‘
â•‘   â”‚            â”‚                       â”‚                       â”‚                                â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                â”‚                       â”‚                       â”‚                                    â•‘
â•‘                â–¼                       â–¼                       â–¼                                    â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚                                   FIELD DEVICES                                             â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚   [Modbus Slave]              [OPC UA Server]              [S7 PLC]                         â”‚   â•‘
â•‘   â”‚    FC05/06/15/16               WriteRequest                 Write DB                        â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                â”‚                                                    â•‘
â•‘                                                â”‚ Result                                             â•‘
â•‘                                                â–¼                                                    â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘   â”‚  RESPONSE PUBLISHED                                                                         â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚  Topic: $nexus/cmd/response/{device_id}/{tag_id}                                            â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â”‚  Payload: {                                                                                 â”‚   â•‘
â•‘   â”‚    "request_id": "abc123",                                                                  â”‚   â•‘
â•‘   â”‚    "device_id": "plc-001",                                                                  â”‚   â•‘
â•‘   â”‚    "tag_id": "temp",                                                                        â”‚   â•‘
â•‘   â”‚    "success": true,                                                                         â”‚   â•‘
â•‘   â”‚    "timestamp": "2024-01-15T10:30:00Z",                                                     â”‚   â•‘
â•‘   â”‚    "duration_ms": 45                                                                        â”‚   â•‘
â•‘   â”‚  }                                                                                          â”‚   â•‘
â•‘   â”‚                                                                                             â”‚   â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## âš™ï¸ Optimizations Summary

### Overview

The NEXUS platform employs multiple optimization techniques to achieve high throughput and low latency while maintaining stability under varying loads.

**Key optimization categories:**
1. **Memory Management**: Object pooling, atomic counters
2. **Connection Pooling**: Per-protocol pools with lazy creation
3. **Circuit Breaker**: Fault tolerance and fast-fail
4. **Back-Pressure**: Graceful degradation under load
5. **Batching**: Reduced I/O overhead
6. **Database Optimization**: TimescaleDB-specific features

```mermaid
flowchart TB
    subgraph Memory["1ï¸âƒ£ MEMORY MANAGEMENT"]
        SP["sync.Pool<br/>DataPoint slices<br/>Pre-allocated cap: 64"]
        BP["Batch Pool<br/>AcquireBatch/ReleaseBatch"]
        AC["Atomic Counters<br/>Lock-free stats"]
    end

    subgraph Pooling["2ï¸âƒ£ CONNECTION POOLING"]
        direction LR
        MP["Modbus Pool<br/>Max: 100"]
        OP["OPC UA Pool<br/>Max: 50"]
        S7P["S7 Pool<br/>Max: 100"]
    end

    subgraph Circuit["3ï¸âƒ£ CIRCUIT BREAKER"]
        CB["sony/gobreaker"]
        CLOSED[CLOSED] -->|"failures â‰¥ 60%"| OPEN[OPEN]
        OPEN -->|"30-60s timeout"| HALF[HALF-OPEN]
        HALF -->|"success"| CLOSED
        HALF -->|"failure"| OPEN
    end

    subgraph BackPressure["4ï¸âƒ£ BACK-PRESSURE"]
        WP["Worker Pool<br/>Skip if busy"]
        BQ["Bounded Queue<br/>Reject if full"]
        PC["Points Channel<br/>Drop if full"]
    end

    subgraph Batching["5ï¸âƒ£ BATCHING"]
        PB["PublishBatch<br/>MQTT efficiency"]
        DB["COPY protocol<br/>10-100x faster"]
        RT["ReadTags<br/>Multi-tag reads"]
    end

    subgraph Database["6ï¸âƒ£ DATABASE"]
        HT["Hypertable<br/>Auto-partitioning"]
        CA["Continuous Aggregates<br/>Pre-computed rollups"]
        COMP["Compression<br/>10-20x reduction"]
        RET["Retention Policies<br/>Auto-cleanup"]
    end

    style Memory fill:#e8f5e9
    style Pooling fill:#fff3e0
    style Circuit fill:#ffebee
    style BackPressure fill:#e3f2fd
    style Batching fill:#f3e5f5
    style Database fill:#fce4ec
```

```mermaid
flowchart LR
    subgraph Jitter["POLLING JITTER DISTRIBUTION"]
        direction TB
        D1["Device 1<br/>Poll at T+0ms"]
        D2["Device 2<br/>Poll at T+50ms"]
        D3["Device 3<br/>Poll at T+80ms"]
        D4["Device 4<br/>Poll at T+30ms"]
        
        NOTE["Jitter = rand(0, interval/10)<br/>Prevents synchronized bursts<br/>Distributes load evenly"]
    end

    subgraph Timeline["TIME â†’"]
        T0["T+0"] --> T1["T+30"] --> T2["T+50"] --> T3["T+80"] --> T4["T+100"]
    end

    D1 -.-> T0
    D4 -.-> T1
    D2 -.-> T2
    D3 -.-> T3

    style Jitter fill:#e8f5e9
    style Timeline fill:#fff3e0
```

```mermaid
graph TB
    subgraph CircuitStates["Circuit Breaker State Machine"]
        C["ğŸŸ¢ CLOSED<br/>Normal operation<br/>Requests pass through"]
        O["ğŸ”´ OPEN<br/>Fast-fail mode<br/>All requests rejected"]
        H["ğŸŸ¡ HALF-OPEN<br/>Testing recovery<br/>Limited requests"]
        
        C -->|"Failure ratio â‰¥ 60%<br/>Min 5-10 requests"| O
        O -->|"Timeout 30-60s"| H
        H -->|"3 successes"| C
        H -->|"Any failure"| O
    end

    style C fill:#c8e6c9
    style O fill:#ffcdd2
    style H fill:#fff9c4
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                   OPTIMIZATION TECHNIQUES                                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  1. MEMORY MANAGEMENT                                                                        â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  â€¢ sync.Pool for DataPoint slices (pre-allocated cap: 64)                                    â”‚   â•‘
â•‘  â”‚    â†’ Reduces GC pressure by recycling allocations                                            â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  â€¢ Batch domain object pool (AcquireBatch/ReleaseBatch)                                      â”‚   â•‘
â•‘  â”‚    â†’ Reuses batch containers in high-throughput ingestion                                    â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  â€¢ Atomic counters (sync/atomic) for statistics                                              â”‚   â•‘
â•‘  â”‚    â†’ Lock-free performance tracking                                                          â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  2. CONNECTION POOLING                                                                       â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Per-Protocol Pools:                                                                         â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â•‘
â•‘  â”‚  â”‚  Modbus Pool       â”‚  OPC UA Pool       â”‚  S7 Pool           â”‚                            â”‚   â•‘
â•‘  â”‚  â”‚  Max: 100          â”‚  Max: 50           â”‚  Max: 100          â”‚                            â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Features:                                                                                   â”‚   â•‘
â•‘  â”‚  â€¢ Lazy connection creation (on-demand)                                                      â”‚   â•‘
â•‘  â”‚  â€¢ Background health check loops (30s interval)                                              â”‚   â•‘
â•‘  â”‚  â€¢ Idle connection reaper (5min timeout)                                                     â”‚   â•‘
â•‘  â”‚  â€¢ Automatic reconnection on connection loss                                                 â”‚   â•‘
â•‘  â”‚  â€¢ Connection eviction under pressure (LRU)                                                  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  3. CIRCUIT BREAKER PATTERN (sony/gobreaker)                                                 â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  States: CLOSED â”€failure rate â‰¥ thresholdâ”€â”€> OPEN â”€â”€timeoutâ”€â”€> HALF-OPEN â”€â”€successâ”€â”€> CLOSED â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Configuration:                                                                              â”‚   â•‘
â•‘  â”‚  â€¢ MaxRequests (half-open): 3                                                                â”‚   â•‘
â•‘  â”‚  â€¢ Interval (count reset): 10s                                                               â”‚   â•‘
â•‘  â”‚  â€¢ Timeout (open â†’ half-open): 30-60s                                                        â”‚   â•‘
â•‘  â”‚  â€¢ FailureRatio threshold: 50-60%                                                            â”‚   â•‘
â•‘  â”‚  â€¢ MinRequests before trip: 5-10                                                             â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Benefits:                                                                                   â”‚   â•‘
â•‘  â”‚  â€¢ Prevents cascade failures                                                                 â”‚   â•‘
â•‘  â”‚  â€¢ Fast-fail for known-bad connections                                                       â”‚   â•‘
â•‘  â”‚  â€¢ Automatic recovery attempts                                                               â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  4. BACK-PRESSURE MECHANISMS                                                                 â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Protocol Gateway (Polling):                                                                 â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â•‘
â•‘  â”‚  â”‚  Worker Pool (chan struct{}, size: 10)                                              â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Non-blocking acquire with `select { case ... default: skip }`                    â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Skip poll cycle if all workers busy                                              â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Track skipped polls in stats (SkippedPolls counter)                              â”‚     â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Protocol Gateway (Commands):                                                                â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â•‘
â•‘  â”‚  â”‚  Bounded Queue (chan WriteCommand, size: 1000)                                      â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Non-blocking enqueue with `select { case ... default: reject }`                  â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Reject commands when queue full                                                  â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Return error response: "queue full, try again later"                             â”‚     â”‚   â•‘
â•‘  â”‚  â”‚                                                                                     â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  Write Semaphore (chan struct{}, size: 50)                                          â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Limits concurrent write operations                                               â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Reject when rate limit exceeded                                                  â”‚     â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Data Ingestion:                                                                             â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â•‘
â•‘  â”‚  â”‚  Points Channel (chan *DataPoint, size: 10000)                                      â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Non-blocking send with `select { case ... default: drop }`                       â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Drop data points when buffer full                                                â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  â€¢ Track dropped points (pointsDropped counter)                                     â”‚     â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  5. BATCHING & BULK OPERATIONS                                                               â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  MQTT Publishing:                                                                            â”‚   â•‘
â•‘  â”‚  â€¢ PublishBatch() for multiple data points in single operation                               â”‚   â•‘
â•‘  â”‚  â€¢ Reduces MQTT round-trips                                                                  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Database Writes:                                                                            â”‚   â•‘
â•‘  â”‚  â€¢ Batcher accumulates points (BatchSize: 1000)                                              â”‚   â•‘
â•‘  â”‚  â€¢ Time-based flush (FlushInterval: 100ms)                                                   â”‚   â•‘
â•‘  â”‚  â€¢ COPY FROM STDIN protocol (pgx)                                                            â”‚   â•‘
â•‘  â”‚    â†’ 10-100x faster than individual INSERTs                                                  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Protocol Reads:                                                                             â”‚   â•‘
â•‘  â”‚  â€¢ ReadTags() reads multiple tags per request                                                â”‚   â•‘
â•‘  â”‚  â€¢ Reduces protocol overhead (connection setup, framing)                                     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  6. POLLING OPTIMIZATION                                                                     â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Jitter Distribution:                                                                        â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â•‘
â•‘  â”‚  â”‚  // Spread device polls over 0-10% of interval                                      â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  jitterMax := device.PollInterval / 10                                              â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  jitter := time.Duration(rand.Int63n(int64(jitterMax)))                             â”‚     â”‚   â•‘
â•‘  â”‚  â”‚  time.Sleep(jitter)  // Initial delay before first poll                             â”‚     â”‚   â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Benefits:                                                                                   â”‚   â•‘
â•‘  â”‚  â€¢ Prevents synchronized bursts                                                              â”‚   â•‘
â•‘  â”‚  â€¢ Distributes load evenly over time                                                         â”‚   â•‘
â•‘  â”‚  â€¢ Reduces peak CPU/memory usage                                                             â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  7. DATABASE OPTIMIZATION (TimescaleDB)                                                      â”‚   â•‘
â•‘  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Hypertable:                                                                                 â”‚   â•‘
â•‘  â”‚  â€¢ Automatic time-based partitioning (chunks)                                                â”‚   â•‘
â•‘  â”‚  â€¢ Index on (topic, time DESC) for efficient queries                                         â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Continuous Aggregates:                                                                      â”‚   â•‘
â•‘  â”‚  â€¢ metrics_1min, metrics_1hour, metrics_1day                                                 â”‚   â•‘
â•‘  â”‚  â€¢ Pre-computed AVG, MIN, MAX, COUNT                                                         â”‚   â•‘
â•‘  â”‚  â€¢ Automatic refresh on new data                                                             â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Compression:                                                                                â”‚   â•‘
â•‘  â”‚  â€¢ Compress data older than 7 days                                                           â”‚   â•‘
â•‘  â”‚  â€¢ Segment by topic for optimal compression                                                  â”‚   â•‘
â•‘  â”‚  â€¢ 10-20x storage reduction                                                                  â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â”‚  Retention:                                                                                  â”‚   â•‘
â•‘  â”‚  â€¢ Raw data: 30 days                                                                         â”‚   â•‘
â•‘  â”‚  â€¢ Hourly aggregates: 1 year                                                                 â”‚   â•‘
â•‘  â”‚  â€¢ Daily aggregates: 5 years                                                                 â”‚   â•‘
â•‘  â”‚                                                                                              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ›ï¸ Infrastructure & Deployment

### Overview

The NEXUS platform supports two deployment modes: **Docker Compose** for development and **Kubernetes** for production. Both configurations provide networking isolation, persistent storage, and health monitoring.

**Network architecture:**
- **nexus-internal**: Bridge network for service-to-service communication (172.28.0.0/16)
- **nexus-ot**: Bridge to OT network for Protocol Gateway access to PLCs

**Kubernetes features:**
- Horizontal Pod Autoscaler (HPA) for automatic scaling
- Pod Disruption Budgets (PDB) for high availability
- Network Policies for security isolation
- Resource quotas and limits for fair scheduling

```mermaid
flowchart TB
    subgraph DockerCompose["ğŸ³ DOCKER COMPOSE (Development)"]
        subgraph Networks["Networks"]
            NI["nexus-internal<br/>172.28.0.0/16"]
            NOT["nexus-ot<br/>OT Bridge"]
        end
        
        subgraph Volumes["Persistent Volumes"]
            V1["emqx-data"]
            V2["timescale-data"]
            V3["postgres-data"]
            V4["nodered-data"]
            V5["grafana-data"]
        end
        
        subgraph Services["Services"]
            S1["All services on<br/>nexus-internal"]
            S2["Protocol Gateway<br/>also on nexus-ot"]
        end
    end

    subgraph Kubernetes["â˜¸ï¸ KUBERNETES (Production)"]
        subgraph NS["Namespace: nexus-edge"]
            subgraph Deploy["Deployments + HPA"]
                D1["protocol-gateway<br/>min:2 max:10"]
                D2["data-ingestion<br/>min:2 max:10"]
                D3["gateway-core<br/>min:2 max:5"]
            end
            
            subgraph Stateful["StatefulSets"]
                SS1["emqx<br/>3 replicas"]
                SS2["timescaledb<br/>1 replica + backup"]
            end
            
            subgraph Protection["Protection"]
                PDB["PDB<br/>minAvailable: 1"]
                NP["Network Policies<br/>Default deny"]
                RQ["Resource Quota<br/>20 CPU, 40Gi"]
            end
        end
    end

    style DockerCompose fill:#e3f2fd
    style Kubernetes fill:#e8f5e9
```

```mermaid
flowchart LR
    subgraph HPA["Horizontal Pod Autoscaler"]
        direction TB
        M["Metrics Server<br/>CPU Usage"]
        HPA_CTRL["HPA Controller"]
        SCALE["Scale Decision"]
        
        M --> HPA_CTRL
        HPA_CTRL --> SCALE
    end

    subgraph Pods["Pod Scaling"]
        P1["Pod 1"]
        P2["Pod 2"]
        P3["Pod 3<br/>(scaled up)"]
        P4["Pod N<br/>(max: 10)"]
    end

    SCALE -->|"CPU > 70%"| P3
    P3 -.->|"CPU < 50%"| P2

    style HPA fill:#fff3e0
    style Pods fill:#e8f5e9
```

```mermaid
flowchart TB
    subgraph StartupOrder["Service Startup Order"]
        direction LR
        S1["1. Databases<br/>PostgreSQL<br/>TimescaleDB"] 
        S2["2. Message Broker<br/>EMQX"]
        S3["3. Core Services<br/>Protocol Gateway<br/>Data Ingestion<br/>Alert Service"]
        S4["4. Flow Engine<br/>Node-RED"]
        S5["5. API Gateway<br/>Gateway Core"]
        S6["6. Frontend<br/>React + Nginx"]
        
        S1 --> S2 --> S3 --> S4 --> S5 --> S6
    end

    style S1 fill:#fce4ec
    style S2 fill:#fff3e0
    style S3 fill:#e8f5e9
    style S4 fill:#e3f2fd
    style S5 fill:#f3e5f5
    style S6 fill:#e1f5fe
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                  DEPLOYMENT ARCHITECTURE                                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚                               DOCKER COMPOSE (Development)                                 â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  Networks:                                                                                 â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚     â•‘
â•‘  â”‚  â”‚  nexus-internal         â”‚  â”‚  nexus-ot               â”‚                                  â”‚     â•‘
â•‘  â”‚  â”‚  172.28.0.0/16          â”‚  â”‚  (OT Network Bridge)    â”‚                                  â”‚     â•‘
â•‘  â”‚  â”‚                         â”‚  â”‚                         â”‚                                  â”‚     â•‘
â•‘  â”‚  â”‚  All services           â”‚  â”‚  Protocol Gateway       â”‚                                  â”‚     â•‘
â•‘  â”‚  â”‚  communicate here       â”‚  â”‚  â†” PLCs/Devices         â”‚                                  â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  Volumes:                                                                                  â”‚     â•‘
â•‘  â”‚  â€¢ emqx-data, emqx-log                                                                     â”‚     â•‘
â•‘  â”‚  â€¢ timescale-data                                                                          â”‚     â•‘
â•‘  â”‚  â€¢ postgres-data                                                                           â”‚     â•‘
â•‘  â”‚  â€¢ nodered-data                                                                            â”‚     â•‘
â•‘  â”‚  â€¢ grafana-data                                                                            â”‚     â•‘
â•‘  â”‚  â€¢ gateway-logs                                                                            â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                                                                     â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘  â”‚                               KUBERNETES (Production)                                      â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  Namespace: nexus-edge                                                                     â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â•‘
â•‘  â”‚  â”‚  Deployments with HPA (Horizontal Pod Autoscaler)                                   â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ protocol-gatewayâ”‚  â”‚ data-ingestion  â”‚  â”‚ gateway-core    â”‚                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ min: 2, max: 10 â”‚  â”‚ min: 2, max: 10 â”‚  â”‚ min: 2, max: 5  â”‚                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ CPU target: 70% â”‚  â”‚ CPU target: 70% â”‚  â”‚ CPU target: 70% â”‚                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â•‘
â•‘  â”‚  â”‚  StatefulSets (Stateful Services)                                                   â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ emqx            â”‚  â”‚ timescaledb     â”‚                                           â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ replicas: 3     â”‚  â”‚ replicas: 1     â”‚                                           â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â”‚ (cluster mode)  â”‚  â”‚ (with backups)  â”‚                                           â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â•‘
â•‘  â”‚  â”‚  Pod Disruption Budgets (PDB)                                                       â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  All services: minAvailable: 1                                                      â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â†’ Ensures at least 1 pod during rolling updates                                    â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â•‘
â•‘  â”‚  â”‚  Network Policies                                                                   â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Default deny all ingress                                                         â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Allow internal namespace traffic                                                 â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Allow ingress from nginx-ingress namespace                                       â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Protocol gateway: allow OT network egress                                        â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â•‘
â•‘  â”‚  â”‚  Resource Controls                                                                  â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  LimitRange (default):                                                              â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ CPU: 100m request, 1000m limit                                                   â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Memory: 128Mi request, 512Mi limit                                               â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  ResourceQuota (namespace):                                                         â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Total CPU: 20 cores                                                              â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Total Memory: 40Gi                                                               â”‚   â”‚     â•‘
â•‘  â”‚  â”‚  â€¢ Max Pods: 100                                                                    â”‚   â”‚     â•‘
â•‘  â”‚  â”‚                                                                                     â”‚   â”‚     â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â•‘
â•‘  â”‚                                                                                            â”‚     â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ˆ Service Dependencies Graph

### Overview

Understanding service dependencies is crucial for proper deployment ordering, debugging, and planning maintenance windows. The NEXUS platform follows a layered dependency model.

**Dependency hierarchy:**
- **Foundation Layer**: PostgreSQL, TimescaleDB (no dependencies)
- **Messaging Layer**: EMQX (depends on nothing)
- **Core Services**: Protocol Gateway, Data Ingestion, Alert Service (depend on EMQX + databases)
- **Processing Layer**: Flow Engine (depends on EMQX + TimescaleDB)
- **API Layer**: Gateway Core (depends on all core services)
- **Presentation Layer**: Frontend, Nginx (depend on Gateway Core)

**Health check cascade:**
If EMQX goes down, all dependent services will show degraded health. TimescaleDB outage affects Data Ingestion and historical queries but not real-time data flow.

```mermaid
flowchart TB
    subgraph Presentation["Presentation Layer"]
        NGINX["Nginx<br/>:80/:443"]
        FE["Frontend<br/>:8080"]
        GRAF["Grafana<br/>:3000"]
    end

    subgraph API["API Layer"]
        GW["Gateway Core<br/>:3000"]
    end

    subgraph Processing["Processing Layer"]
        FE_ENG["Flow Engine<br/>:1880"]
    end

    subgraph Core["Core Services"]
        PG["Protocol Gateway<br/>:4000"]
        DI["Data Ingestion<br/>:7000"]
        AS["Alert Service<br/>:6000"]
        ORCH["Orchestrator<br/>:5000"]
    end

    subgraph Messaging["Messaging Layer"]
        EMQX["EMQX Broker<br/>:1883"]
    end

    subgraph Foundation["Foundation Layer"]
        PSQL[(PostgreSQL<br/>:5433)]
        TSDB[(TimescaleDB<br/>:5432)]
    end

    subgraph OT["OT Network"]
        DEVS["PLCs & Devices"]
    end

    NGINX --> FE
    NGINX --> GW
    NGINX --> GRAF

    GW --> PG
    GW --> FE_ENG
    GW --> AS
    GW --> ORCH
    GW --> PSQL
    GW --> TSDB

    FE_ENG --> EMQX
    FE_ENG --> TSDB

    PG --> EMQX
    PG --> DEVS
    DI --> EMQX
    DI --> TSDB
    AS --> EMQX
    AS --> PSQL

    GRAF --> TSDB

    style Presentation fill:#e1f5fe
    style API fill:#f3e5f5
    style Processing fill:#e8f5e9
    style Core fill:#fff3e0
    style Messaging fill:#ffecb3
    style Foundation fill:#fce4ec
    style OT fill:#f5f5f5
```

```mermaid
flowchart LR
    subgraph HealthCascade["Health Check Cascade"]
        direction TB
        
        subgraph Healthy["âœ… All Healthy"]
            H1["EMQX âœ…"]
            H2["TimescaleDB âœ…"]
            H3["Services âœ…"]
        end
        
        subgraph EMQXDown["âŒ EMQX Down"]
            E1["EMQX âŒ"]
            E2["Protocol Gateway âš ï¸<br/>Can't publish"]
            E3["Data Ingestion âš ï¸<br/>Can't subscribe"]
            E4["Alert Service âš ï¸<br/>No data"]
        end
        
        subgraph TSDBDown["âŒ TimescaleDB Down"]
            T1["TimescaleDB âŒ"]
            T2["Data Ingestion âš ï¸<br/>Can't persist"]
            T3["Grafana âš ï¸<br/>No historical data"]
            T4["Real-time âœ…<br/>Still working"]
        end
    end

    style Healthy fill:#c8e6c9
    style EMQXDown fill:#ffcdd2
    style TSDBDown fill:#fff9c4
```

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                  SERVICE DEPENDENCY MAP                                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                                     â•‘
â•‘                                                                                                     â•‘
â•‘                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â•‘
â•‘                              â”‚         NGINX                 â”‚                                      â•‘
â•‘                              â”‚      (Reverse Proxy)          â”‚                                      â•‘
â•‘                              â”‚       :80, :443               â”‚                                      â•‘
â•‘                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â•‘
â•‘                                             â”‚                                                       â•‘
â•‘                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â•‘
â•‘                           â”‚                 â”‚                 â”‚                                     â•‘
â•‘                           â–¼                 â–¼                 â–¼                                     â•‘
â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â•‘
â•‘              â”‚     FRONTEND       â”‚ â”‚ GATEWAY CORE  â”‚ â”‚     GRAFANA        â”‚                        â•‘
â•‘              â”‚   (React SPA)      â”‚ â”‚  (API GW)     â”‚ â”‚  (Visualization)   â”‚                        â•‘
â•‘              â”‚     :8080          â”‚ â”‚    :3000      â”‚ â”‚     :3000          â”‚                        â•‘
â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â•‘
â•‘                                             â”‚                   â”‚                                   â•‘
â•‘                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â•‘
â•‘                           â”‚                 â”‚                   â”‚                 â”‚                 â•‘
â•‘                           â–¼                 â–¼                   â–¼                 â–¼                 â•‘
â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â•‘
â•‘    â”‚  PROTOCOL    â”‚ â”‚    FLOW      â”‚ â”‚    ALERT     â”‚ â”‚ ORCHESTRATOR â”‚ â”‚    DATA      â”‚             â•‘
â•‘    â”‚  GATEWAY     â”‚ â”‚   ENGINE     â”‚ â”‚   SERVICE    â”‚ â”‚   SERVICE    â”‚ â”‚  INGESTION   â”‚             â•‘
â•‘    â”‚   (Go)       â”‚ â”‚ (Node-RED)   â”‚ â”‚    (Go)      â”‚ â”‚    (Go)      â”‚ â”‚    (Go)      â”‚             â•‘
â•‘    â”‚   :4000      â”‚ â”‚   :1880      â”‚ â”‚   :6000      â”‚ â”‚   :5000      â”‚ â”‚   :7000      â”‚             â•‘
â•‘    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â•‘
â•‘           â”‚                â”‚                â”‚                                  â”‚                    â•‘
â•‘           â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â•‘
â•‘           â”‚                                 â”‚                                  â”‚                    â•‘
â•‘           â–¼                                 â–¼                                  â–¼                    â•‘
â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â•‘
â•‘    â”‚                                    EMQX BROKER                                      â”‚          â•‘
â•‘    â”‚                               (MQTT Message Bus)                                    â”‚          â•‘
â•‘    â”‚                            :1883, :8883, :8083, :8084                               â”‚          â•‘
â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â•‘
â•‘           â”‚                                                                    â”‚                    â•‘
â•‘           â”‚                                                                    â”‚                    â•‘
â•‘           â–¼                                                                    â–¼                    â•‘
â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â•‘
â•‘    â”‚        POSTGRESQL           â”‚                    â”‚          TIMESCALEDB            â”‚           â•‘
â•‘    â”‚     (Config Store)          â”‚                    â”‚          (Historian)            â”‚           â•‘
â•‘    â”‚         :5433               â”‚                    â”‚            :5432                â”‚           â•‘
â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â•‘
â•‘                                                                                                     â•‘
â•‘                                                                                                     â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â•‘
â•‘                                                                                                     â•‘
â•‘  Legend:                                                                                            â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
â•‘  â”‚  â†’  Depends on / Connects to                                                                     â•‘
â•‘  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â•‘
â•‘  â”‚                                                                                                  â•‘
â•‘  â”‚  Startup Order (Docker Compose / K8s):                                                           â•‘
â•‘  â”‚  1. PostgreSQL, TimescaleDB (databases)                                                          â•‘
â•‘  â”‚  2. EMQX (message broker)                                                                        â•‘
â•‘  â”‚  3. Protocol Gateway, Data Ingestion, Alert Service (core services)                              â•‘
â•‘  â”‚  4. Flow Engine (depends on EMQX + TimescaleDB)                                                  â•‘
â•‘  â”‚  5. Gateway Core (depends on all services)                                                       â•‘
â•‘  â”‚  6. Frontend, Nginx (presentation layer)                                                         â•‘
â•‘  â”‚                                                                                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“‹ Technology Stack Summary

### Overview

The NEXUS platform uses a carefully selected technology stack optimized for **industrial IoT workloads**. Go is chosen for performance-critical services due to its low memory footprint and excellent concurrency model. TypeScript provides type safety for frontend and API development.

```mermaid
pie title Technology Distribution by Service Count
    "Go" : 4
    "TypeScript/Node.js" : 2
    "React" : 1
    "External (EMQX, TimescaleDB, PostgreSQL)" : 3
```

```mermaid
flowchart TB
    subgraph Languages["Languages & Runtimes"]
        GO["Go 1.21+<br/>Protocol Gateway<br/>Data Ingestion<br/>Alert Service<br/>Orchestrator"]
        TS["TypeScript<br/>Gateway Core<br/>Frontend"]
        NR["Node-RED<br/>Flow Engine"]
    end

    subgraph Libraries["Key Libraries"]
        GOS7["robinson/gos7<br/>S7 Protocol"]
        GOPCUA["gopcua/opcua<br/>OPC UA"]
        GOMOD["goburrow/modbus<br/>Modbus"]
        GOBRK["sony/gobreaker<br/>Circuit Breaker"]
        PGX["jackc/pgx<br/>PostgreSQL Driver"]
        PAHO["paho.mqtt.golang<br/>MQTT Client"]
    end

    subgraph Infra["Infrastructure"]
        EMQX["EMQX 5.3<br/>MQTT Broker"]
        TSDB["TimescaleDB 2.13<br/>Time-Series DB"]
        PG["PostgreSQL 15<br/>Config Store"]
        DOCKER["Docker/K8s<br/>Orchestration"]
    end

    GO --> GOS7
    GO --> GOPCUA
    GO --> GOMOD
    GO --> GOBRK
    GO --> PGX
    GO --> PAHO

    style Languages fill:#e8f5e9
    style Libraries fill:#fff3e0
    style Infra fill:#e3f2fd
```

| Layer | Component | Technology | Port |
|-------|-----------|------------|------|
| **Presentation** | NEXUS Control Center | React + TypeScript + TailwindCSS | 8080 |
| | Reverse Proxy | Nginx | 80, 443 |
| | API Gateway | Node.js/Express (Gateway Core) | 3000 |
| **Processing** | Protocol Gateway | Go (gos7, gopcua, go-modbus) | 4000 |
| | Flow Engine | Node-RED | 1880 |
| | Alert Service | Go | 6000 |
| | Orchestrator | Go (Docker SDK / client-go) | 5000 |
| **Ingestion** | Data Ingestion | Go (pgx COPY) | 7000 |
| **Messaging** | MQTT Broker | EMQX 5.3 | 1883, 8883, 8083 |
| **Persistence** | Time-Series DB | TimescaleDB 2.13 (PostgreSQL 15) | 5432 |
| | Config DB | PostgreSQL 15 | 5433 |
| **Visualization** | Dashboards | Grafana (optional) | 3000 |

---

## ğŸ”‘ Key Design Patterns

### Overview

The NEXUS platform implements several proven design patterns to achieve reliability, scalability, and maintainability in industrial environments.

```mermaid
mindmap
  root((NEXUS<br/>Design Patterns))
    Resilience
      Circuit Breaker
        Fast-fail for bad connections
        Automatic recovery
      Back-Pressure
        Non-blocking channels
        Graceful degradation
    Performance
      Connection Pooling
        Per-protocol pools
        Lazy creation
        Health checks
      Object Pooling
        sync.Pool
        Batch recycling
      Batching
        Size-based triggers
        Time-based triggers
    Architecture
      Unified Namespace
        Hierarchical MQTT topics
        Self-documenting data
      CQRS-like
        Separate read path (polling)
        Separate write path (commands)
    Reliability
      Jitter Distribution
        Prevents thundering herd
        Even load distribution
```

```mermaid
flowchart LR
    subgraph CQRS["CQRS-like Pattern"]
        direction TB
        
        subgraph Read["READ PATH"]
            POLL["Polling Service<br/>Interval-based"]
            PROTO["Protocol Pools<br/>ReadTags()"]
            PUB["MQTT Publish<br/>Data flow"]
        end
        
        subgraph Write["WRITE PATH"]
            SUB["MQTT Subscribe<br/>$nexus/cmd/#"]
            CMD["Command Handler<br/>Validation"]
            WR["Protocol Pools<br/>WriteTag()"]
        end
        
        POLL --> PROTO --> PUB
        SUB --> CMD --> WR
    end

    style Read fill:#e8f5e9
    style Write fill:#fff3e0
```

```mermaid
flowchart TB
    subgraph UNS["Unified Namespace Pattern"]
        direction LR
        
        ROOT["Enterprise"]
        SITE["Site"]
        AREA["Area"]
        LINE["Line"]
        DEV["Device"]
        TAG["Tag"]
        
        ROOT --> SITE --> AREA --> LINE --> DEV --> TAG
        
        EX1["acme/chicago/bldg-a/line-1/plc-001/temperature"]
        EX2["acme/chicago/bldg-a/line-1/plc-001/pressure"]
        EX3["acme/chicago/bldg-a/line-2/robot-01/position"]
    end

    subgraph Benefits["Benefits"]
        B1["âœ“ Self-documenting"]
        B2["âœ“ Wildcard subscriptions"]
        B3["âœ“ Easy integration"]
        B4["âœ“ Natural hierarchy"]
    end

    style UNS fill:#e8f5e9
    style Benefits fill:#e3f2fd
```

| Pattern | Implementation | Purpose |
|---------|---------------|---------|
| **Connection Pooling** | Per-protocol pools (Modbus/OPC UA/S7) | Efficient connection reuse, reduced latency |
| **Circuit Breaker** | sony/gobreaker | Fault tolerance, cascade failure prevention |
| **Back-Pressure** | Non-blocking channels with bounded queues | Graceful degradation under load |
| **Object Pooling** | sync.Pool for DataPoint slices | Reduced GC pressure, lower latency |
| **Batching** | Size (1000) + Time (100ms) triggers | Reduced I/O overhead, higher throughput |
| **Jitter Distribution** | Random 0-10% of poll interval | Prevents synchronized bursts |
| **Unified Namespace** | Hierarchical MQTT topics | Self-documenting, easy integration |
| **CQRS-like** | Separate read/write paths | Optimized for each use case |

---

## ğŸ“Š Quick Reference Diagrams

### Service Communication Matrix

```mermaid
flowchart TB
    subgraph External["External Access"]
        USER["ğŸ‘¤ Users"]
        PLCS["ğŸ­ PLCs"]
    end

    subgraph Platform["NEXUS Platform"]
        FE["Frontend"]
        GW["Gateway"]
        PG["Protocol GW"]
        DI["Ingestion"]
        EMQX["EMQX"]
        TSDB["TimescaleDB"]
    end

    USER -->|"HTTP/WS"| FE
    USER -->|"REST API"| GW
    PLCS -->|"S7/OPC/Modbus"| PG
    
    FE -->|"REST"| GW
    GW -->|"MQTT"| EMQX
    PG -->|"MQTT"| EMQX
    DI -->|"MQTT"| EMQX
    DI -->|"SQL"| TSDB
    GW -->|"SQL"| TSDB
```

### Data Throughput Path

```mermaid
flowchart LR
    A["ğŸ“¡ 100+ Devices<br/>1000+ Tags"] 
    B["âš™ï¸ Protocol Gateway<br/>10 Workers"]
    C["ğŸ“¨ EMQX<br/>100K msg/s"]
    D["ğŸ“¥ Data Ingestion<br/>4 Writers"]
    E["ğŸ’¾ TimescaleDB<br/>COPY protocol"]

    A -->|"Poll every 1s"| B
    B -->|"PublishBatch"| C
    C -->|"Subscribe +/#"| D
    D -->|"1000 pts/batch"| E

    style A fill:#f5f5f5
    style B fill:#e8f5e9
    style C fill:#fff3e0
    style D fill:#e3f2fd
    style E fill:#fce4ec
```

---

*Generated from codebase analysis - Last updated: January 2026*

> ğŸ’¡ **Tip**: View this file with Mermaid support enabled (GitHub, GitLab, VS Code with extension) for interactive diagrams.

